"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.LOG_VERDACCIO_ERROR = exports.LOG_VERDACCIO_BYTES = exports.LOG_STATUS_MESSAGE = void 0;
exports.allow = allow;
exports.antiLoop = antiLoop;
exports.encodeScopePackage = encodeScopePackage;
exports.errorReportingMiddleware = errorReportingMiddleware;
exports.expectJson = expectJson;
exports.final = final;
exports.handleError = handleError;
exports.log = log;
exports.match = match;
exports.media = media;
exports.serveFavicon = serveFavicon;
exports.setSecurityWebHeaders = setSecurityWebHeaders;
exports.validateName = validateName;
exports.validatePackage = validatePackage;
var _debug = _interopRequireDefault(require("debug"));
var _fs = _interopRequireDefault(require("fs"));
var _lodash = _interopRequireDefault(require("lodash"));
var _path = _interopRequireDefault(require("path"));
var _validator = _interopRequireDefault(require("validator"));
var _utils = require("@verdaccio/utils");
var _constants = require("../lib/constants");
var _logger = require("../lib/logger");
var _utils2 = require("../lib/utils");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const debug = (0, _debug.default)('verdaccio');
function match(regexp) {
  return function (req, res, next, value) {
    if (regexp.exec(value)) {
      next();
    } else {
      next('route');
    }
  };
}
function serveFavicon(config) {
  return function (req, res, next) {
    try {
      var _config$web;
      // @ts-ignore
      const logoConf = config === null || config === void 0 ? void 0 : (_config$web = config.web) === null || _config$web === void 0 ? void 0 : _config$web.favicon;
      if (logoConf === '') {
        debug('favicon disabled');
        res.status(404);
      } else if (!_lodash.default.isEmpty(logoConf)) {
        debug('custom favicon');
        if (_validator.default.isURL(logoConf, {
          require_host: true,
          require_valid_protocol: true
        })) {
          debug('redirect to %o', logoConf);
          res.redirect(logoConf);
          return;
        } else {
          const faviconPath = _path.default.normalize(logoConf);
          debug('serving favicon from %o', faviconPath);
          _fs.default.access(faviconPath, _fs.default.constants.R_OK, err => {
            if (err) {
              debug('no read permissions to read: %o, reason:', logoConf, err === null || err === void 0 ? void 0 : err.message);
              return res.status(_constants.HTTP_STATUS.NOT_FOUND).end();
            } else {
              res.setHeader('content-type', 'image/x-icon');
              _fs.default.createReadStream(faviconPath).pipe(res);
              debug('rendered custom ico');
            }
          });
        }
      } else {
        res.setHeader('content-type', 'image/x-icon');
        _fs.default.createReadStream(_path.default.posix.join(__dirname, './web/html/favicon.ico')).pipe(res);
        debug('rendered ico');
      }
    } catch (err) {
      debug('error triggered, favicon not found');
      res.status(_constants.HTTP_STATUS.NOT_FOUND).end();
    }
  };
}
function setSecurityWebHeaders(req, res, next) {
  // disable loading in frames (clickjacking, etc.)
  res.header(_constants.HEADERS.FRAMES_OPTIONS, 'deny');
  // avoid stablish connections outside of domain
  res.header(_constants.HEADERS.CSP, "connect-src 'self'");
  // https://stackoverflow.com/questions/18337630/what-is-x-content-type-options-nosniff
  res.header(_constants.HEADERS.CTO, 'nosniff');
  // https://stackoverflow.com/questions/9090577/what-is-the-http-header-x-xss-protection
  res.header(_constants.HEADERS.XSS, '1; mode=block');
  next();
}

// flow: express does not match properly
// flow info https://github.com/flowtype/flow-typed/issues?utf8=%E2%9C%93&q=is%3Aissue+is%3Aopen+express
function validateName(req, res, next, value, name) {
  if (value === '-') {
    // special case in couchdb usually
    next('route');
  } else if ((0, _utils.validateName)(value)) {
    next();
  } else {
    next(_utils2.ErrorCode.getForbidden('invalid ' + name));
  }
}

// flow: express does not match properly
// flow info https://github.com/flowtype/flow-typed/issues?utf8=%E2%9C%93&q=is%3Aissue+is%3Aopen+express
function validatePackage(req, res, next, value, name) {
  if (value === '-') {
    // special case in couchdb usually
    next('route');
  } else if ((0, _utils.validatePackage)(value)) {
    next();
  } else {
    next(_utils2.ErrorCode.getForbidden('invalid ' + name));
  }
}
function media(expect) {
  return function (req, res, next) {
    if (req.headers[_constants.HEADER_TYPE.CONTENT_TYPE] !== expect) {
      next(_utils2.ErrorCode.getCode(_constants.HTTP_STATUS.UNSUPPORTED_MEDIA, 'wrong content-type, expect: ' + expect + ', got: ' + req.get(_constants.HEADER_TYPE.CONTENT_TYPE)));
    } else {
      next();
    }
  };
}
function encodeScopePackage(req, res, next) {
  if (req.url.indexOf('@') !== -1) {
    // e.g.: /@org/pkg/1.2.3 -> /@org%2Fpkg/1.2.3, /@org%2Fpkg/1.2.3 -> /@org%2Fpkg/1.2.3
    req.url = req.url.replace(/^(\/@[^\/%]+)\/(?!$)/, '$1%2F');
  }
  next();
}
function expectJson(req, res, next) {
  if (!(0, _utils2.isObject)(req.body)) {
    return next(_utils2.ErrorCode.getBadRequest("can't parse incoming json"));
  }
  next();
}
function antiLoop(config) {
  return function (req, res, next) {
    var _req$headers;
    if ((req === null || req === void 0 ? void 0 : (_req$headers = req.headers) === null || _req$headers === void 0 ? void 0 : _req$headers.via) != null) {
      const arr = req.headers.via.split(',');
      for (let i = 0; i < arr.length; i++) {
        const m = arr[i].match(/\s*(\S+)\s+(\S+)/);
        if (m && m[2] === config.server_id) {
          return next(_utils2.ErrorCode.getCode(_constants.HTTP_STATUS.LOOP_DETECTED, 'loop detected'));
        }
      }
    }
    next();
  };
}
function handleError(err, req, res, next) {
  debug('error handler init');
  if (_lodash.default.isError(err)) {
    debug('is native error');
    if (err.code === 'ECONNABORT' && res.statusCode === _constants.HTTP_STATUS.NOT_MODIFIED) {
      return next();
    }
    if (_lodash.default.isFunction(res.locals.report_error) === false) {
      debug('is locals error report ref');
      // in case of very early error this middleware may not be loaded before error is generated
      // fixing that
      errorReportingMiddleware(req, res, _lodash.default.noop);
    }
    debug('set locals error report ref');
    res.locals.report_error(err);
  } else {
    // Fall to Middleware.final
    debug('no error to report, jump next layer');
    return next(err);
  }
}
function allow(auth) {
  return function (action) {
    return function (req, res, next) {
      req.pause();
      const packageName = req.params.scope ? `@${req.params.scope}/${req.params.package}` : req.params.package;
      let packageVersion = undefined;
      if (req.params.filename) {
        packageVersion = (0, _utils2.getVersionFromTarball)(req.params.filename) || undefined;
      } else if (typeof req.body.versions === 'object') {
        packageVersion = Object.keys(req.body.versions)[0];
      }
      const remote = req.remote_user;
      debug('[middleware/allow][%o] allow for %o', action, remote === null || remote === void 0 ? void 0 : remote.name);
      auth['allow_' + action]({
        packageName,
        packageVersion
      }, remote, function (error, allowed) {
        req.resume();
        if (error) {
          next(error);
        } else if (allowed) {
          next();
        } else {
          // last plugin (that's our built-in one) returns either
          // cb(err) or cb(null, true), so this should never happen
          throw _utils2.ErrorCode.getInternalError(_constants.API_ERROR.PLUGIN_ERROR);
        }
      });
    };
  };
}
function final(body, req, res, next) {
  if (res.statusCode === _constants.HTTP_STATUS.UNAUTHORIZED && !res.getHeader(_constants.HEADERS.WWW_AUTH)) {
    // they say it's required for 401, so...
    res.header(_constants.HEADERS.WWW_AUTH, `${_constants.TOKEN_BASIC}, ${_constants.TOKEN_BEARER}`);
  }
  try {
    if (_lodash.default.isString(body) || _lodash.default.isObject(body)) {
      if (!res.getHeader(_constants.HEADERS.CONTENT_TYPE)) {
        res.header(_constants.HEADERS.CONTENT_TYPE, _constants.HEADERS.JSON);
      }
      if (typeof body === 'object' && _lodash.default.isNil(body) === false) {
        if (typeof body.error === 'string') {
          res.locals._verdaccio_error = body.error;
        }
        body = JSON.stringify(body);
      }

      // don't send etags with errors
      if (!res.statusCode || res.statusCode >= _constants.HTTP_STATUS.OK && res.statusCode < _constants.HTTP_STATUS.MULTIPLE_CHOICES) {
        res.header(_constants.HEADERS.ETAG, '"' + (0, _utils.stringToMD5)(body) + '"');
      }
    } else {
      // send(null), send(204), etc.
    }
  } catch (err) {
    // if verdaccio sends headers first, and then calls res.send()
    // as an error handler, we can't report error properly,
    // and should just close socket
    if (err.message.match(/set headers after they are sent/)) {
      if (_lodash.default.isNil(res.socket) === false) {
        // @ts-ignore
        res.socket.destroy();
      }
      return;
    }
    throw err;
  }
  res.send(body);
}
const LOG_STATUS_MESSAGE = "@{status}, user: @{user}(@{remoteIP}), req: '@{request.method} @{request.url}'";
exports.LOG_STATUS_MESSAGE = LOG_STATUS_MESSAGE;
const LOG_VERDACCIO_ERROR = `${LOG_STATUS_MESSAGE}, error: @{!error}`;
exports.LOG_VERDACCIO_ERROR = LOG_VERDACCIO_ERROR;
const LOG_VERDACCIO_BYTES = `${LOG_STATUS_MESSAGE}, bytes: @{bytes.in}/@{bytes.out}`;
exports.LOG_VERDACCIO_BYTES = LOG_VERDACCIO_BYTES;
function log(config) {
  return function (req, res, next) {
    var _config$experiments;
    const _auth = req.headers.authorization;
    if (_lodash.default.isNil(_auth) === false) {
      req.headers.authorization = '<Classified>';
    }
    const _cookie = req.get('cookie');
    if (_lodash.default.isNil(_cookie) === false) {
      req.headers.cookie = '<Classified>';
    }
    req.url = req.originalUrl;
    // avoid log noise data from static content
    if (req.originalUrl.match(/static/) === null) {
      _logger.logger.http({
        req: req,
        ip: req.ip
      }, "@{ip} requested '@{req.method} @{req.url}'");
    }
    req.originalUrl = req.url;
    if (_lodash.default.isNil(_auth) === false) {
      req.headers.authorization = _auth;
    }
    if (_lodash.default.isNil(_cookie) === false) {
      req.headers.cookie = _cookie;
    }
    let bytesin = 0;
    if ((config === null || config === void 0 ? void 0 : (_config$experiments = config.experiments) === null || _config$experiments === void 0 ? void 0 : _config$experiments.bytesin_off) !== true) {
      req.on('data', function (chunk) {
        bytesin += chunk.length;
      });
    }
    let bytesout = 0;
    const _write = res.write;
    // FIXME: res.write should return boolean
    // @ts-ignore
    res.write = function (buf) {
      bytesout += buf.length;
      /* eslint prefer-rest-params: "off" */
      // @ts-ignore
      _write.apply(res, arguments);
    };
    let logHasBeenCalled = false;
    const log = function () {
      if (logHasBeenCalled) {
        return;
      }
      logHasBeenCalled = true;
      const forwardedFor = req.get('x-forwarded-for');
      const remoteAddress = req.connection.remoteAddress;
      const remoteIP = forwardedFor ? `${forwardedFor} via ${remoteAddress}` : remoteAddress;
      let message;
      if (res.locals._verdaccio_error) {
        message = LOG_VERDACCIO_ERROR;
      } else {
        message = LOG_VERDACCIO_BYTES;
      }
      req.url = req.originalUrl;
      // avoid log noise data from static content
      if (req.url.match(/static/) === null) {
        _logger.logger.http({
          request: {
            method: req.method,
            url: req.url
          },
          user: req.remote_user && req.remote_user.name || null,
          remoteIP,
          status: res.statusCode,
          error: res.locals._verdaccio_error,
          bytes: {
            in: bytesin,
            out: bytesout
          }
        }, message);
        req.originalUrl = req.url;
      }
    };
    req.on('close', function () {
      log();
    });
    const _end = res.end;
    // @ts-ignore
    res.end = function (buf) {
      if (buf) {
        bytesout += buf.length;
      }
      /* eslint prefer-rest-params: "off" */
      // @ts-ignore
      _end.apply(res, arguments);
      log();
    };
    next();
  };
}

// Middleware
function errorReportingMiddleware(req, res, next) {
  res.locals.report_error = res.locals.report_error || function (err) {
    if (err.status && err.status >= _constants.HTTP_STATUS.BAD_REQUEST && err.status < 600) {
      if (!res.headersSent) {
        res.status(err.status);
        next({
          error: err.message || _constants.API_ERROR.UNKNOWN_ERROR
        });
      }
    } else {
      _logger.logger.error({
        err: err
      }, 'unexpected error: @{!err.message}\n@{err.stack}');
      if (!res.status || !res.send) {
        _logger.logger.error('this is an error in express.js, please report this');
        res.destroy();
      } else if (!res.headersSent) {
        res.status(_constants.HTTP_STATUS.INTERNAL_ERROR);
        next({
          error: _constants.API_ERROR.INTERNAL_SERVER_ERROR
        });
      } else {
        // socket should be already closed
      }
    }
  };
  next();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkZWJ1ZyIsImJ1aWxkRGVidWciLCJtYXRjaCIsInJlZ2V4cCIsInJlcSIsInJlcyIsIm5leHQiLCJ2YWx1ZSIsImV4ZWMiLCJzZXJ2ZUZhdmljb24iLCJjb25maWciLCJsb2dvQ29uZiIsIndlYiIsImZhdmljb24iLCJzdGF0dXMiLCJfIiwiaXNFbXB0eSIsInZhbGlkYXRvciIsImlzVVJMIiwicmVxdWlyZV9ob3N0IiwicmVxdWlyZV92YWxpZF9wcm90b2NvbCIsInJlZGlyZWN0IiwiZmF2aWNvblBhdGgiLCJwYXRoIiwibm9ybWFsaXplIiwiZnMiLCJhY2Nlc3MiLCJjb25zdGFudHMiLCJSX09LIiwiZXJyIiwibWVzc2FnZSIsIkhUVFBfU1RBVFVTIiwiTk9UX0ZPVU5EIiwiZW5kIiwic2V0SGVhZGVyIiwiY3JlYXRlUmVhZFN0cmVhbSIsInBpcGUiLCJwb3NpeCIsImpvaW4iLCJfX2Rpcm5hbWUiLCJzZXRTZWN1cml0eVdlYkhlYWRlcnMiLCJoZWFkZXIiLCJIRUFERVJTIiwiRlJBTUVTX09QVElPTlMiLCJDU1AiLCJDVE8iLCJYU1MiLCJ2YWxpZGF0ZU5hbWUiLCJuYW1lIiwidXRpbFZhbGlkYXRlTmFtZSIsIkVycm9yQ29kZSIsImdldEZvcmJpZGRlbiIsInZhbGlkYXRlUGFja2FnZSIsInV0aWxWYWxpZGF0ZVBhY2thZ2UiLCJtZWRpYSIsImV4cGVjdCIsImhlYWRlcnMiLCJIRUFERVJfVFlQRSIsIkNPTlRFTlRfVFlQRSIsImdldENvZGUiLCJVTlNVUFBPUlRFRF9NRURJQSIsImdldCIsImVuY29kZVNjb3BlUGFja2FnZSIsInVybCIsImluZGV4T2YiLCJyZXBsYWNlIiwiZXhwZWN0SnNvbiIsImlzT2JqZWN0IiwiYm9keSIsImdldEJhZFJlcXVlc3QiLCJhbnRpTG9vcCIsInZpYSIsImFyciIsInNwbGl0IiwiaSIsImxlbmd0aCIsIm0iLCJzZXJ2ZXJfaWQiLCJMT09QX0RFVEVDVEVEIiwiaGFuZGxlRXJyb3IiLCJpc0Vycm9yIiwiY29kZSIsInN0YXR1c0NvZGUiLCJOT1RfTU9ESUZJRUQiLCJpc0Z1bmN0aW9uIiwibG9jYWxzIiwicmVwb3J0X2Vycm9yIiwiZXJyb3JSZXBvcnRpbmdNaWRkbGV3YXJlIiwibm9vcCIsImFsbG93IiwiYXV0aCIsImFjdGlvbiIsInBhdXNlIiwicGFja2FnZU5hbWUiLCJwYXJhbXMiLCJzY29wZSIsInBhY2thZ2UiLCJwYWNrYWdlVmVyc2lvbiIsInVuZGVmaW5lZCIsImZpbGVuYW1lIiwiZ2V0VmVyc2lvbkZyb21UYXJiYWxsIiwidmVyc2lvbnMiLCJPYmplY3QiLCJrZXlzIiwicmVtb3RlIiwicmVtb3RlX3VzZXIiLCJlcnJvciIsImFsbG93ZWQiLCJyZXN1bWUiLCJnZXRJbnRlcm5hbEVycm9yIiwiQVBJX0VSUk9SIiwiUExVR0lOX0VSUk9SIiwiZmluYWwiLCJVTkFVVEhPUklaRUQiLCJnZXRIZWFkZXIiLCJXV1dfQVVUSCIsIlRPS0VOX0JBU0lDIiwiVE9LRU5fQkVBUkVSIiwiaXNTdHJpbmciLCJKU09OIiwiaXNOaWwiLCJfdmVyZGFjY2lvX2Vycm9yIiwic3RyaW5naWZ5IiwiT0siLCJNVUxUSVBMRV9DSE9JQ0VTIiwiRVRBRyIsInN0cmluZ1RvTUQ1Iiwic29ja2V0IiwiZGVzdHJveSIsInNlbmQiLCJMT0dfU1RBVFVTX01FU1NBR0UiLCJMT0dfVkVSREFDQ0lPX0VSUk9SIiwiTE9HX1ZFUkRBQ0NJT19CWVRFUyIsImxvZyIsIl9hdXRoIiwiYXV0aG9yaXphdGlvbiIsIl9jb29raWUiLCJjb29raWUiLCJvcmlnaW5hbFVybCIsImxvZ2dlciIsImh0dHAiLCJpcCIsImJ5dGVzaW4iLCJleHBlcmltZW50cyIsImJ5dGVzaW5fb2ZmIiwib24iLCJjaHVuayIsImJ5dGVzb3V0IiwiX3dyaXRlIiwid3JpdGUiLCJidWYiLCJhcHBseSIsImFyZ3VtZW50cyIsImxvZ0hhc0JlZW5DYWxsZWQiLCJmb3J3YXJkZWRGb3IiLCJyZW1vdGVBZGRyZXNzIiwiY29ubmVjdGlvbiIsInJlbW90ZUlQIiwicmVxdWVzdCIsIm1ldGhvZCIsInVzZXIiLCJieXRlcyIsImluIiwib3V0IiwiX2VuZCIsIkJBRF9SRVFVRVNUIiwiaGVhZGVyc1NlbnQiLCJVTktOT1dOX0VSUk9SIiwiSU5URVJOQUxfRVJST1IiLCJJTlRFUk5BTF9TRVJWRVJfRVJST1IiXSwic291cmNlcyI6WyIuLi8uLi9zcmMvYXBpL21pZGRsZXdhcmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGJ1aWxkRGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IEh0dHBFcnJvciB9IGZyb20gJ2h0dHAtZXJyb3JzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB2YWxpZGF0b3IgZnJvbSAndmFsaWRhdG9yJztcblxuaW1wb3J0IHsgQ29uZmlnLCBQYWNrYWdlLCBSZW1vdGVVc2VyIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5pbXBvcnQgeyBzdHJpbmdUb01ENSB9IGZyb20gJ0B2ZXJkYWNjaW8vdXRpbHMnO1xuaW1wb3J0IHtcbiAgdmFsaWRhdGVOYW1lIGFzIHV0aWxWYWxpZGF0ZU5hbWUsXG4gIHZhbGlkYXRlUGFja2FnZSBhcyB1dGlsVmFsaWRhdGVQYWNrYWdlLFxufSBmcm9tICdAdmVyZGFjY2lvL3V0aWxzJztcblxuaW1wb3J0IHtcbiAgQVBJX0VSUk9SLFxuICBIRUFERVJTLFxuICBIRUFERVJfVFlQRSxcbiAgSFRUUF9TVEFUVVMsXG4gIFRPS0VOX0JBU0lDLFxuICBUT0tFTl9CRUFSRVIsXG59IGZyb20gJy4uL2xpYi9jb25zdGFudHMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vbGliL2xvZ2dlcic7XG5pbXBvcnQgeyBFcnJvckNvZGUsIGdldFZlcnNpb25Gcm9tVGFyYmFsbCwgaXNPYmplY3QgfSBmcm9tICcuLi9saWIvdXRpbHMnO1xuaW1wb3J0IHsgJE5leHRGdW5jdGlvblZlciwgJFJlcXVlc3RFeHRlbmQsICRSZXNwb25zZUV4dGVuZCwgSUF1dGggfSBmcm9tICcuLi90eXBlcyc7XG5cbmNvbnN0IGRlYnVnID0gYnVpbGREZWJ1ZygndmVyZGFjY2lvJyk7XG5cbmV4cG9ydCBmdW5jdGlvbiBtYXRjaChyZWdleHA6IFJlZ0V4cCk6IGFueSB7XG4gIHJldHVybiBmdW5jdGlvbiAoXG4gICAgcmVxOiAkUmVxdWVzdEV4dGVuZCxcbiAgICByZXM6ICRSZXNwb25zZUV4dGVuZCxcbiAgICBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyLFxuICAgIHZhbHVlOiBzdHJpbmdcbiAgKTogdm9pZCB7XG4gICAgaWYgKHJlZ2V4cC5leGVjKHZhbHVlKSkge1xuICAgICAgbmV4dCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBuZXh0KCdyb3V0ZScpO1xuICAgIH1cbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlcnZlRmF2aWNvbihjb25maWc6IENvbmZpZykge1xuICByZXR1cm4gZnVuY3Rpb24gKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGNvbnN0IGxvZ29Db25mOiBzdHJpbmcgPSBjb25maWc/LndlYj8uZmF2aWNvbiBhcyBzdHJpbmc7XG4gICAgICBpZiAobG9nb0NvbmYgPT09ICcnKSB7XG4gICAgICAgIGRlYnVnKCdmYXZpY29uIGRpc2FibGVkJyk7XG4gICAgICAgIHJlcy5zdGF0dXMoNDA0KTtcbiAgICAgIH0gZWxzZSBpZiAoIV8uaXNFbXB0eShsb2dvQ29uZikpIHtcbiAgICAgICAgZGVidWcoJ2N1c3RvbSBmYXZpY29uJyk7XG4gICAgICAgIGlmIChcbiAgICAgICAgICB2YWxpZGF0b3IuaXNVUkwobG9nb0NvbmYsIHtcbiAgICAgICAgICAgIHJlcXVpcmVfaG9zdDogdHJ1ZSxcbiAgICAgICAgICAgIHJlcXVpcmVfdmFsaWRfcHJvdG9jb2w6IHRydWUsXG4gICAgICAgICAgfSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgZGVidWcoJ3JlZGlyZWN0IHRvICVvJywgbG9nb0NvbmYpO1xuICAgICAgICAgIHJlcy5yZWRpcmVjdChsb2dvQ29uZik7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGZhdmljb25QYXRoID0gcGF0aC5ub3JtYWxpemUobG9nb0NvbmYpO1xuICAgICAgICAgIGRlYnVnKCdzZXJ2aW5nIGZhdmljb24gZnJvbSAlbycsIGZhdmljb25QYXRoKTtcbiAgICAgICAgICBmcy5hY2Nlc3MoZmF2aWNvblBhdGgsIGZzLmNvbnN0YW50cy5SX09LLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIGRlYnVnKCdubyByZWFkIHBlcm1pc3Npb25zIHRvIHJlYWQ6ICVvLCByZWFzb246JywgbG9nb0NvbmYsIGVycj8ubWVzc2FnZSk7XG4gICAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCkuZW5kKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXMuc2V0SGVhZGVyKCdjb250ZW50LXR5cGUnLCAnaW1hZ2UveC1pY29uJyk7XG4gICAgICAgICAgICAgIGZzLmNyZWF0ZVJlYWRTdHJlYW0oZmF2aWNvblBhdGgpLnBpcGUocmVzKTtcbiAgICAgICAgICAgICAgZGVidWcoJ3JlbmRlcmVkIGN1c3RvbSBpY28nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLnNldEhlYWRlcignY29udGVudC10eXBlJywgJ2ltYWdlL3gtaWNvbicpO1xuICAgICAgICBmcy5jcmVhdGVSZWFkU3RyZWFtKHBhdGgucG9zaXguam9pbihfX2Rpcm5hbWUsICcuL3dlYi9odG1sL2Zhdmljb24uaWNvJykpLnBpcGUocmVzKTtcbiAgICAgICAgZGVidWcoJ3JlbmRlcmVkIGljbycpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgZGVidWcoJ2Vycm9yIHRyaWdnZXJlZCwgZmF2aWNvbiBub3QgZm91bmQnKTtcbiAgICAgIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKS5lbmQoKTtcbiAgICB9XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRTZWN1cml0eVdlYkhlYWRlcnMoXG4gIHJlcTogJFJlcXVlc3RFeHRlbmQsXG4gIHJlczogJFJlc3BvbnNlRXh0ZW5kLFxuICBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyXG4pOiB2b2lkIHtcbiAgLy8gZGlzYWJsZSBsb2FkaW5nIGluIGZyYW1lcyAoY2xpY2tqYWNraW5nLCBldGMuKVxuICByZXMuaGVhZGVyKEhFQURFUlMuRlJBTUVTX09QVElPTlMsICdkZW55Jyk7XG4gIC8vIGF2b2lkIHN0YWJsaXNoIGNvbm5lY3Rpb25zIG91dHNpZGUgb2YgZG9tYWluXG4gIHJlcy5oZWFkZXIoSEVBREVSUy5DU1AsIFwiY29ubmVjdC1zcmMgJ3NlbGYnXCIpO1xuICAvLyBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xODMzNzYzMC93aGF0LWlzLXgtY29udGVudC10eXBlLW9wdGlvbnMtbm9zbmlmZlxuICByZXMuaGVhZGVyKEhFQURFUlMuQ1RPLCAnbm9zbmlmZicpO1xuICAvLyBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy85MDkwNTc3L3doYXQtaXMtdGhlLWh0dHAtaGVhZGVyLXgteHNzLXByb3RlY3Rpb25cbiAgcmVzLmhlYWRlcihIRUFERVJTLlhTUywgJzE7IG1vZGU9YmxvY2snKTtcbiAgbmV4dCgpO1xufVxuXG4vLyBmbG93OiBleHByZXNzIGRvZXMgbm90IG1hdGNoIHByb3Blcmx5XG4vLyBmbG93IGluZm8gaHR0cHM6Ly9naXRodWIuY29tL2Zsb3d0eXBlL2Zsb3ctdHlwZWQvaXNzdWVzP3V0Zjg9JUUyJTlDJTkzJnE9aXMlM0Fpc3N1ZStpcyUzQW9wZW4rZXhwcmVzc1xuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlTmFtZShcbiAgcmVxOiAkUmVxdWVzdEV4dGVuZCxcbiAgcmVzOiAkUmVzcG9uc2VFeHRlbmQsXG4gIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIsXG4gIHZhbHVlOiBzdHJpbmcsXG4gIG5hbWU6IHN0cmluZ1xuKTogdm9pZCB7XG4gIGlmICh2YWx1ZSA9PT0gJy0nKSB7XG4gICAgLy8gc3BlY2lhbCBjYXNlIGluIGNvdWNoZGIgdXN1YWxseVxuICAgIG5leHQoJ3JvdXRlJyk7XG4gIH0gZWxzZSBpZiAodXRpbFZhbGlkYXRlTmFtZSh2YWx1ZSkpIHtcbiAgICBuZXh0KCk7XG4gIH0gZWxzZSB7XG4gICAgbmV4dChFcnJvckNvZGUuZ2V0Rm9yYmlkZGVuKCdpbnZhbGlkICcgKyBuYW1lKSk7XG4gIH1cbn1cblxuLy8gZmxvdzogZXhwcmVzcyBkb2VzIG5vdCBtYXRjaCBwcm9wZXJseVxuLy8gZmxvdyBpbmZvIGh0dHBzOi8vZ2l0aHViLmNvbS9mbG93dHlwZS9mbG93LXR5cGVkL2lzc3Vlcz91dGY4PSVFMiU5QyU5MyZxPWlzJTNBaXNzdWUraXMlM0FvcGVuK2V4cHJlc3NcbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVBhY2thZ2UoXG4gIHJlcTogJFJlcXVlc3RFeHRlbmQsXG4gIHJlczogJFJlc3BvbnNlRXh0ZW5kLFxuICBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyLFxuICB2YWx1ZTogc3RyaW5nLFxuICBuYW1lOiBzdHJpbmdcbik6IHZvaWQge1xuICBpZiAodmFsdWUgPT09ICctJykge1xuICAgIC8vIHNwZWNpYWwgY2FzZSBpbiBjb3VjaGRiIHVzdWFsbHlcbiAgICBuZXh0KCdyb3V0ZScpO1xuICB9IGVsc2UgaWYgKHV0aWxWYWxpZGF0ZVBhY2thZ2UodmFsdWUpKSB7XG4gICAgbmV4dCgpO1xuICB9IGVsc2Uge1xuICAgIG5leHQoRXJyb3JDb2RlLmdldEZvcmJpZGRlbignaW52YWxpZCAnICsgbmFtZSkpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtZWRpYShleHBlY3Q6IHN0cmluZyB8IG51bGwpOiBhbnkge1xuICByZXR1cm4gZnVuY3Rpb24gKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgaWYgKHJlcS5oZWFkZXJzW0hFQURFUl9UWVBFLkNPTlRFTlRfVFlQRV0gIT09IGV4cGVjdCkge1xuICAgICAgbmV4dChcbiAgICAgICAgRXJyb3JDb2RlLmdldENvZGUoXG4gICAgICAgICAgSFRUUF9TVEFUVVMuVU5TVVBQT1JURURfTUVESUEsXG4gICAgICAgICAgJ3dyb25nIGNvbnRlbnQtdHlwZSwgZXhwZWN0OiAnICsgZXhwZWN0ICsgJywgZ290OiAnICsgcmVxLmdldChIRUFERVJfVFlQRS5DT05URU5UX1RZUEUpXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5leHQoKTtcbiAgICB9XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlbmNvZGVTY29wZVBhY2thZ2UoXG4gIHJlcTogJFJlcXVlc3RFeHRlbmQsXG4gIHJlczogJFJlc3BvbnNlRXh0ZW5kLFxuICBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyXG4pOiB2b2lkIHtcbiAgaWYgKHJlcS51cmwuaW5kZXhPZignQCcpICE9PSAtMSkge1xuICAgIC8vIGUuZy46IC9Ab3JnL3BrZy8xLjIuMyAtPiAvQG9yZyUyRnBrZy8xLjIuMywgL0BvcmclMkZwa2cvMS4yLjMgLT4gL0BvcmclMkZwa2cvMS4yLjNcbiAgICByZXEudXJsID0gcmVxLnVybC5yZXBsYWNlKC9eKFxcL0BbXlxcLyVdKylcXC8oPyEkKS8sICckMSUyRicpO1xuICB9XG4gIG5leHQoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4cGVjdEpzb24oXG4gIHJlcTogJFJlcXVlc3RFeHRlbmQsXG4gIHJlczogJFJlc3BvbnNlRXh0ZW5kLFxuICBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyXG4pOiB2b2lkIHtcbiAgaWYgKCFpc09iamVjdChyZXEuYm9keSkpIHtcbiAgICByZXR1cm4gbmV4dChFcnJvckNvZGUuZ2V0QmFkUmVxdWVzdChcImNhbid0IHBhcnNlIGluY29taW5nIGpzb25cIikpO1xuICB9XG4gIG5leHQoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFudGlMb29wKGNvbmZpZzogQ29uZmlnKTogRnVuY3Rpb24ge1xuICByZXR1cm4gZnVuY3Rpb24gKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgaWYgKHJlcT8uaGVhZGVycz8udmlhICE9IG51bGwpIHtcbiAgICAgIGNvbnN0IGFyciA9IHJlcS5oZWFkZXJzLnZpYS5zcGxpdCgnLCcpO1xuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBtID0gYXJyW2ldLm1hdGNoKC9cXHMqKFxcUyspXFxzKyhcXFMrKS8pO1xuICAgICAgICBpZiAobSAmJiBtWzJdID09PSBjb25maWcuc2VydmVyX2lkKSB7XG4gICAgICAgICAgcmV0dXJuIG5leHQoRXJyb3JDb2RlLmdldENvZGUoSFRUUF9TVEFUVVMuTE9PUF9ERVRFQ1RFRCwgJ2xvb3AgZGV0ZWN0ZWQnKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgbmV4dCgpO1xuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFuZGxlRXJyb3IoXG4gIGVycjogSHR0cEVycm9yLFxuICByZXE6ICRSZXF1ZXN0RXh0ZW5kLFxuICByZXM6ICRSZXNwb25zZUV4dGVuZCxcbiAgbmV4dDogJE5leHRGdW5jdGlvblZlclxuKSB7XG4gIGRlYnVnKCdlcnJvciBoYW5kbGVyIGluaXQnKTtcbiAgaWYgKF8uaXNFcnJvcihlcnIpKSB7XG4gICAgZGVidWcoJ2lzIG5hdGl2ZSBlcnJvcicpO1xuICAgIGlmIChlcnIuY29kZSA9PT0gJ0VDT05OQUJPUlQnICYmIHJlcy5zdGF0dXNDb2RlID09PSBIVFRQX1NUQVRVUy5OT1RfTU9ESUZJRUQpIHtcbiAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgfVxuICAgIGlmIChfLmlzRnVuY3Rpb24ocmVzLmxvY2Fscy5yZXBvcnRfZXJyb3IpID09PSBmYWxzZSkge1xuICAgICAgZGVidWcoJ2lzIGxvY2FscyBlcnJvciByZXBvcnQgcmVmJyk7XG4gICAgICAvLyBpbiBjYXNlIG9mIHZlcnkgZWFybHkgZXJyb3IgdGhpcyBtaWRkbGV3YXJlIG1heSBub3QgYmUgbG9hZGVkIGJlZm9yZSBlcnJvciBpcyBnZW5lcmF0ZWRcbiAgICAgIC8vIGZpeGluZyB0aGF0XG4gICAgICBlcnJvclJlcG9ydGluZ01pZGRsZXdhcmUocmVxLCByZXMsIF8ubm9vcCk7XG4gICAgfVxuICAgIGRlYnVnKCdzZXQgbG9jYWxzIGVycm9yIHJlcG9ydCByZWYnKTtcbiAgICByZXMubG9jYWxzLnJlcG9ydF9lcnJvcihlcnIpO1xuICB9IGVsc2Uge1xuICAgIC8vIEZhbGwgdG8gTWlkZGxld2FyZS5maW5hbFxuICAgIGRlYnVnKCdubyBlcnJvciB0byByZXBvcnQsIGp1bXAgbmV4dCBsYXllcicpO1xuICAgIHJldHVybiBuZXh0KGVycik7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFsbG93KGF1dGg6IElBdXRoKTogRnVuY3Rpb24ge1xuICByZXR1cm4gZnVuY3Rpb24gKGFjdGlvbjogc3RyaW5nKTogRnVuY3Rpb24ge1xuICAgIHJldHVybiBmdW5jdGlvbiAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpOiB2b2lkIHtcbiAgICAgIHJlcS5wYXVzZSgpO1xuICAgICAgY29uc3QgcGFja2FnZU5hbWUgPSByZXEucGFyYW1zLnNjb3BlXG4gICAgICAgID8gYEAke3JlcS5wYXJhbXMuc2NvcGV9LyR7cmVxLnBhcmFtcy5wYWNrYWdlfWBcbiAgICAgICAgOiByZXEucGFyYW1zLnBhY2thZ2U7XG4gICAgICBsZXQgcGFja2FnZVZlcnNpb246IHN0cmluZyB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICAgIGlmIChyZXEucGFyYW1zLmZpbGVuYW1lKSB7XG4gICAgICAgIHBhY2thZ2VWZXJzaW9uID0gZ2V0VmVyc2lvbkZyb21UYXJiYWxsKHJlcS5wYXJhbXMuZmlsZW5hbWUpIHx8IHVuZGVmaW5lZDtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlcS5ib2R5LnZlcnNpb25zID09PSAnb2JqZWN0Jykge1xuICAgICAgICBwYWNrYWdlVmVyc2lvbiA9IE9iamVjdC5rZXlzKHJlcS5ib2R5LnZlcnNpb25zKVswXTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlbW90ZTogUmVtb3RlVXNlciA9IHJlcS5yZW1vdGVfdXNlcjtcbiAgICAgIGRlYnVnKCdbbWlkZGxld2FyZS9hbGxvd11bJW9dIGFsbG93IGZvciAlbycsIGFjdGlvbiwgcmVtb3RlPy5uYW1lKTtcbiAgICAgIGF1dGhbJ2FsbG93XycgKyBhY3Rpb25dKFxuICAgICAgICB7IHBhY2thZ2VOYW1lLCBwYWNrYWdlVmVyc2lvbiB9LFxuICAgICAgICByZW1vdGUsXG4gICAgICAgIGZ1bmN0aW9uIChlcnJvciwgYWxsb3dlZCk6IHZvaWQge1xuICAgICAgICAgIHJlcS5yZXN1bWUoKTtcbiAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIG5leHQoZXJyb3IpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoYWxsb3dlZCkge1xuICAgICAgICAgICAgbmV4dCgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBsYXN0IHBsdWdpbiAodGhhdCdzIG91ciBidWlsdC1pbiBvbmUpIHJldHVybnMgZWl0aGVyXG4gICAgICAgICAgICAvLyBjYihlcnIpIG9yIGNiKG51bGwsIHRydWUpLCBzbyB0aGlzIHNob3VsZCBuZXZlciBoYXBwZW5cbiAgICAgICAgICAgIHRocm93IEVycm9yQ29kZS5nZXRJbnRlcm5hbEVycm9yKEFQSV9FUlJPUi5QTFVHSU5fRVJST1IpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9O1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1pZGRsZXdhcmVFcnJvciB7XG4gIGVycm9yOiBzdHJpbmc7XG59XG5cbmV4cG9ydCB0eXBlIEZpbmFsQm9keSA9IFBhY2thZ2UgfCBNaWRkbGV3YXJlRXJyb3IgfCBzdHJpbmc7XG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5hbChcbiAgYm9keTogRmluYWxCb2R5LFxuICByZXE6ICRSZXF1ZXN0RXh0ZW5kLFxuICByZXM6ICRSZXNwb25zZUV4dGVuZCxcbiAgbmV4dDogJE5leHRGdW5jdGlvblZlclxuKTogdm9pZCB7XG4gIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gSFRUUF9TVEFUVVMuVU5BVVRIT1JJWkVEICYmICFyZXMuZ2V0SGVhZGVyKEhFQURFUlMuV1dXX0FVVEgpKSB7XG4gICAgLy8gdGhleSBzYXkgaXQncyByZXF1aXJlZCBmb3IgNDAxLCBzby4uLlxuICAgIHJlcy5oZWFkZXIoSEVBREVSUy5XV1dfQVVUSCwgYCR7VE9LRU5fQkFTSUN9LCAke1RPS0VOX0JFQVJFUn1gKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgaWYgKF8uaXNTdHJpbmcoYm9keSkgfHwgXy5pc09iamVjdChib2R5KSkge1xuICAgICAgaWYgKCFyZXMuZ2V0SGVhZGVyKEhFQURFUlMuQ09OVEVOVF9UWVBFKSkge1xuICAgICAgICByZXMuaGVhZGVyKEhFQURFUlMuQ09OVEVOVF9UWVBFLCBIRUFERVJTLkpTT04pO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZW9mIGJvZHkgPT09ICdvYmplY3QnICYmIF8uaXNOaWwoYm9keSkgPT09IGZhbHNlKSB7XG4gICAgICAgIGlmICh0eXBlb2YgKGJvZHkgYXMgTWlkZGxld2FyZUVycm9yKS5lcnJvciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICByZXMubG9jYWxzLl92ZXJkYWNjaW9fZXJyb3IgPSAoYm9keSBhcyBNaWRkbGV3YXJlRXJyb3IpLmVycm9yO1xuICAgICAgICB9XG4gICAgICAgIGJvZHkgPSBKU09OLnN0cmluZ2lmeShib2R5KTtcbiAgICAgIH1cblxuICAgICAgLy8gZG9uJ3Qgc2VuZCBldGFncyB3aXRoIGVycm9yc1xuICAgICAgaWYgKFxuICAgICAgICAhcmVzLnN0YXR1c0NvZGUgfHxcbiAgICAgICAgKHJlcy5zdGF0dXNDb2RlID49IEhUVFBfU1RBVFVTLk9LICYmIHJlcy5zdGF0dXNDb2RlIDwgSFRUUF9TVEFUVVMuTVVMVElQTEVfQ0hPSUNFUylcbiAgICAgICkge1xuICAgICAgICByZXMuaGVhZGVyKEhFQURFUlMuRVRBRywgJ1wiJyArIHN0cmluZ1RvTUQ1KGJvZHkgYXMgc3RyaW5nKSArICdcIicpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBzZW5kKG51bGwpLCBzZW5kKDIwNCksIGV0Yy5cbiAgICB9XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIGlmIHZlcmRhY2NpbyBzZW5kcyBoZWFkZXJzIGZpcnN0LCBhbmQgdGhlbiBjYWxscyByZXMuc2VuZCgpXG4gICAgLy8gYXMgYW4gZXJyb3IgaGFuZGxlciwgd2UgY2FuJ3QgcmVwb3J0IGVycm9yIHByb3Blcmx5LFxuICAgIC8vIGFuZCBzaG91bGQganVzdCBjbG9zZSBzb2NrZXRcbiAgICBpZiAoZXJyLm1lc3NhZ2UubWF0Y2goL3NldCBoZWFkZXJzIGFmdGVyIHRoZXkgYXJlIHNlbnQvKSkge1xuICAgICAgaWYgKF8uaXNOaWwocmVzLnNvY2tldCkgPT09IGZhbHNlKSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgcmVzLnNvY2tldC5kZXN0cm95KCk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxuXG4gIHJlcy5zZW5kKGJvZHkpO1xufVxuXG5leHBvcnQgY29uc3QgTE9HX1NUQVRVU19NRVNTQUdFID1cbiAgXCJAe3N0YXR1c30sIHVzZXI6IEB7dXNlcn0oQHtyZW1vdGVJUH0pLCByZXE6ICdAe3JlcXVlc3QubWV0aG9kfSBAe3JlcXVlc3QudXJsfSdcIjtcbmV4cG9ydCBjb25zdCBMT0dfVkVSREFDQ0lPX0VSUk9SID0gYCR7TE9HX1NUQVRVU19NRVNTQUdFfSwgZXJyb3I6IEB7IWVycm9yfWA7XG5leHBvcnQgY29uc3QgTE9HX1ZFUkRBQ0NJT19CWVRFUyA9IGAke0xPR19TVEFUVVNfTUVTU0FHRX0sIGJ5dGVzOiBAe2J5dGVzLmlufS9Ae2J5dGVzLm91dH1gO1xuXG5leHBvcnQgZnVuY3Rpb24gbG9nKGNvbmZpZzogQ29uZmlnKSB7XG4gIHJldHVybiBmdW5jdGlvbiAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpOiB2b2lkIHtcbiAgICBjb25zdCBfYXV0aCA9IHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb247XG4gICAgaWYgKF8uaXNOaWwoX2F1dGgpID09PSBmYWxzZSkge1xuICAgICAgcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbiA9ICc8Q2xhc3NpZmllZD4nO1xuICAgIH1cblxuICAgIGNvbnN0IF9jb29raWUgPSByZXEuZ2V0KCdjb29raWUnKTtcbiAgICBpZiAoXy5pc05pbChfY29va2llKSA9PT0gZmFsc2UpIHtcbiAgICAgIHJlcS5oZWFkZXJzLmNvb2tpZSA9ICc8Q2xhc3NpZmllZD4nO1xuICAgIH1cblxuICAgIHJlcS51cmwgPSByZXEub3JpZ2luYWxVcmw7XG4gICAgLy8gYXZvaWQgbG9nIG5vaXNlIGRhdGEgZnJvbSBzdGF0aWMgY29udGVudFxuICAgIGlmIChyZXEub3JpZ2luYWxVcmwubWF0Y2goL3N0YXRpYy8pID09PSBudWxsKSB7XG4gICAgICBsb2dnZXIuaHR0cCh7IHJlcTogcmVxLCBpcDogcmVxLmlwIH0sIFwiQHtpcH0gcmVxdWVzdGVkICdAe3JlcS5tZXRob2R9IEB7cmVxLnVybH0nXCIpO1xuICAgIH1cbiAgICByZXEub3JpZ2luYWxVcmwgPSByZXEudXJsO1xuXG4gICAgaWYgKF8uaXNOaWwoX2F1dGgpID09PSBmYWxzZSkge1xuICAgICAgcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbiA9IF9hdXRoO1xuICAgIH1cblxuICAgIGlmIChfLmlzTmlsKF9jb29raWUpID09PSBmYWxzZSkge1xuICAgICAgcmVxLmhlYWRlcnMuY29va2llID0gX2Nvb2tpZTtcbiAgICB9XG5cbiAgICBsZXQgYnl0ZXNpbiA9IDA7XG4gICAgaWYgKGNvbmZpZz8uZXhwZXJpbWVudHM/LmJ5dGVzaW5fb2ZmICE9PSB0cnVlKSB7XG4gICAgICByZXEub24oJ2RhdGEnLCBmdW5jdGlvbiAoY2h1bmspOiB2b2lkIHtcbiAgICAgICAgYnl0ZXNpbiArPSBjaHVuay5sZW5ndGg7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBsZXQgYnl0ZXNvdXQgPSAwO1xuICAgIGNvbnN0IF93cml0ZSA9IHJlcy53cml0ZTtcbiAgICAvLyBGSVhNRTogcmVzLndyaXRlIHNob3VsZCByZXR1cm4gYm9vbGVhblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICByZXMud3JpdGUgPSBmdW5jdGlvbiAoYnVmKTogYm9vbGVhbiB7XG4gICAgICBieXRlc291dCArPSBidWYubGVuZ3RoO1xuICAgICAgLyogZXNsaW50IHByZWZlci1yZXN0LXBhcmFtczogXCJvZmZcIiAqL1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgX3dyaXRlLmFwcGx5KHJlcywgYXJndW1lbnRzKTtcbiAgICB9O1xuXG4gICAgbGV0IGxvZ0hhc0JlZW5DYWxsZWQgPSBmYWxzZTtcbiAgICBjb25zdCBsb2cgPSBmdW5jdGlvbiAoKTogdm9pZCB7XG4gICAgICBpZiAobG9nSGFzQmVlbkNhbGxlZCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBsb2dIYXNCZWVuQ2FsbGVkID0gdHJ1ZTtcblxuICAgICAgY29uc3QgZm9yd2FyZGVkRm9yID0gcmVxLmdldCgneC1mb3J3YXJkZWQtZm9yJyk7XG4gICAgICBjb25zdCByZW1vdGVBZGRyZXNzID0gcmVxLmNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzcztcbiAgICAgIGNvbnN0IHJlbW90ZUlQID0gZm9yd2FyZGVkRm9yID8gYCR7Zm9yd2FyZGVkRm9yfSB2aWEgJHtyZW1vdGVBZGRyZXNzfWAgOiByZW1vdGVBZGRyZXNzO1xuICAgICAgbGV0IG1lc3NhZ2U7XG4gICAgICBpZiAocmVzLmxvY2Fscy5fdmVyZGFjY2lvX2Vycm9yKSB7XG4gICAgICAgIG1lc3NhZ2UgPSBMT0dfVkVSREFDQ0lPX0VSUk9SO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWVzc2FnZSA9IExPR19WRVJEQUNDSU9fQllURVM7XG4gICAgICB9XG5cbiAgICAgIHJlcS51cmwgPSByZXEub3JpZ2luYWxVcmw7XG4gICAgICAvLyBhdm9pZCBsb2cgbm9pc2UgZGF0YSBmcm9tIHN0YXRpYyBjb250ZW50XG4gICAgICBpZiAocmVxLnVybC5tYXRjaCgvc3RhdGljLykgPT09IG51bGwpIHtcbiAgICAgICAgbG9nZ2VyLmh0dHAoXG4gICAgICAgICAge1xuICAgICAgICAgICAgcmVxdWVzdDoge1xuICAgICAgICAgICAgICBtZXRob2Q6IHJlcS5tZXRob2QsXG4gICAgICAgICAgICAgIHVybDogcmVxLnVybCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB1c2VyOiAocmVxLnJlbW90ZV91c2VyICYmIHJlcS5yZW1vdGVfdXNlci5uYW1lKSB8fCBudWxsLFxuICAgICAgICAgICAgcmVtb3RlSVAsXG4gICAgICAgICAgICBzdGF0dXM6IHJlcy5zdGF0dXNDb2RlLFxuICAgICAgICAgICAgZXJyb3I6IHJlcy5sb2NhbHMuX3ZlcmRhY2Npb19lcnJvcixcbiAgICAgICAgICAgIGJ5dGVzOiB7XG4gICAgICAgICAgICAgIGluOiBieXRlc2luLFxuICAgICAgICAgICAgICBvdXQ6IGJ5dGVzb3V0LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG1lc3NhZ2VcbiAgICAgICAgKTtcbiAgICAgICAgcmVxLm9yaWdpbmFsVXJsID0gcmVxLnVybDtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgcmVxLm9uKCdjbG9zZScsIGZ1bmN0aW9uICgpOiB2b2lkIHtcbiAgICAgIGxvZygpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgX2VuZCA9IHJlcy5lbmQ7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHJlcy5lbmQgPSBmdW5jdGlvbiAoYnVmKTogdm9pZCB7XG4gICAgICBpZiAoYnVmKSB7XG4gICAgICAgIGJ5dGVzb3V0ICs9IGJ1Zi5sZW5ndGg7XG4gICAgICB9XG4gICAgICAvKiBlc2xpbnQgcHJlZmVyLXJlc3QtcGFyYW1zOiBcIm9mZlwiICovXG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBfZW5kLmFwcGx5KHJlcywgYXJndW1lbnRzKTtcbiAgICAgIGxvZygpO1xuICAgIH07XG4gICAgbmV4dCgpO1xuICB9O1xufVxuXG4vLyBNaWRkbGV3YXJlXG5leHBvcnQgZnVuY3Rpb24gZXJyb3JSZXBvcnRpbmdNaWRkbGV3YXJlKFxuICByZXE6ICRSZXF1ZXN0RXh0ZW5kLFxuICByZXM6ICRSZXNwb25zZUV4dGVuZCxcbiAgbmV4dDogJE5leHRGdW5jdGlvblZlclxuKTogdm9pZCB7XG4gIHJlcy5sb2NhbHMucmVwb3J0X2Vycm9yID1cbiAgICByZXMubG9jYWxzLnJlcG9ydF9lcnJvciB8fFxuICAgIGZ1bmN0aW9uIChlcnI6IGFueSk6IHZvaWQge1xuICAgICAgaWYgKGVyci5zdGF0dXMgJiYgZXJyLnN0YXR1cyA+PSBIVFRQX1NUQVRVUy5CQURfUkVRVUVTVCAmJiBlcnIuc3RhdHVzIDwgNjAwKSB7XG4gICAgICAgIGlmICghcmVzLmhlYWRlcnNTZW50KSB7XG4gICAgICAgICAgcmVzLnN0YXR1cyhlcnIuc3RhdHVzKTtcbiAgICAgICAgICBuZXh0KHsgZXJyb3I6IGVyci5tZXNzYWdlIHx8IEFQSV9FUlJPUi5VTktOT1dOX0VSUk9SIH0pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZXJyb3IoeyBlcnI6IGVyciB9LCAndW5leHBlY3RlZCBlcnJvcjogQHshZXJyLm1lc3NhZ2V9XFxuQHtlcnIuc3RhY2t9Jyk7XG4gICAgICAgIGlmICghcmVzLnN0YXR1cyB8fCAhcmVzLnNlbmQpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoJ3RoaXMgaXMgYW4gZXJyb3IgaW4gZXhwcmVzcy5qcywgcGxlYXNlIHJlcG9ydCB0aGlzJyk7XG4gICAgICAgICAgcmVzLmRlc3Ryb3koKTtcbiAgICAgICAgfSBlbHNlIGlmICghcmVzLmhlYWRlcnNTZW50KSB7XG4gICAgICAgICAgcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5JTlRFUk5BTF9FUlJPUik7XG4gICAgICAgICAgbmV4dCh7IGVycm9yOiBBUElfRVJST1IuSU5URVJOQUxfU0VSVkVSX0VSUk9SIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIHNvY2tldCBzaG91bGQgYmUgYWxyZWFkeSBjbG9zZWRcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG5cbiAgbmV4dCgpO1xufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFFQTtBQUNBO0FBQ0E7QUFHQTtBQU1BO0FBUUE7QUFDQTtBQUEwRTtBQUcxRSxNQUFNQSxLQUFLLEdBQUcsSUFBQUMsY0FBVSxFQUFDLFdBQVcsQ0FBQztBQUU5QixTQUFTQyxLQUFLLENBQUNDLE1BQWMsRUFBTztFQUN6QyxPQUFPLFVBQ0xDLEdBQW1CLEVBQ25CQyxHQUFvQixFQUNwQkMsSUFBc0IsRUFDdEJDLEtBQWEsRUFDUDtJQUNOLElBQUlKLE1BQU0sQ0FBQ0ssSUFBSSxDQUFDRCxLQUFLLENBQUMsRUFBRTtNQUN0QkQsSUFBSSxFQUFFO0lBQ1IsQ0FBQyxNQUFNO01BQ0xBLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDZjtFQUNGLENB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