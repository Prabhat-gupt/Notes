"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;
var _lodash = _interopRequireDefault(require("lodash"));
var _semver = _interopRequireDefault(require("semver"));
var _constants = require("../../../../lib/constants");
var _logger = require("../../../../lib/logger");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const personMatch = (person, search) => {
  if (typeof person === 'string') {
    return person.includes(search);
  }
  if (typeof person === 'object') {
    for (const field of Object.values(person)) {
      if (typeof field === 'string' && field.includes(search)) {
        return true;
      }
    }
  }
  return false;
};
const matcher = function (query) {
  const match = query.match(/author:(.*)/);
  if (match !== null) {
    return function (pkg) {
      return personMatch(pkg.author, match[1]);
    };
  }

  // TODO: maintainer, keywords, boost-exact
  // TODO implement some scoring system for freetext
  return pkg => {
    return ['name', 'displayName', 'description'].map(k => {
      return pkg[k];
    }).filter(x => {
      return x !== undefined;
    }).some(txt => {
      return txt.includes(query);
    });
  };
};
function compileTextSearch(textSearch) {
  const textMatchers = (textSearch || '').split(' ').map(matcher);
  return pkg => textMatchers.every(m => m(pkg));
}
function removeDuplicates(results) {
  const pkgNames = [];
  return results.filter(pkg => {
    var _pkg$package, _pkg$package2;
    if (pkgNames.includes(pkg === null || pkg === void 0 ? void 0 : (_pkg$package = pkg.package) === null || _pkg$package === void 0 ? void 0 : _pkg$package.name)) {
      return false;
    }
    pkgNames.push(pkg === null || pkg === void 0 ? void 0 : (_pkg$package2 = pkg.package) === null || _pkg$package2 === void 0 ? void 0 : _pkg$package2.name);
    return true;
  });
}
function checkAccess(pkg, auth, remoteUser) {
  return new Promise((resolve, reject) => {
    var _pkg$package3;
    auth.allow_access({
      packageName: pkg === null || pkg === void 0 ? void 0 : (_pkg$package3 = pkg.package) === null || _pkg$package3 === void 0 ? void 0 : _pkg$package3.name
    }, remoteUser, function (err, allowed) {
      if (err) {
        if (err.status && String(err.status).match(/^4\d\d$/)) {
          // auth plugin returns 4xx user error,
          // that's equivalent of !allowed basically
          allowed = false;
          return resolve(null);
        } else {
          reject(err);
        }
      } else {
        return resolve(allowed ? pkg : null);
      }
    });
  });
}
async function sendResponse(resultBuf, resultStream, auth, req, from, size) {
  resultStream.destroy();
  const resultsCollection = resultBuf.map(pkg => {
    if (pkg !== null && pkg !== void 0 && pkg.name) {
      return {
        package: pkg,
        // not sure if flags is need it
        flags: {
          unstable: Object.keys(pkg.versions).some(v => _semver.default.satisfies(v, '^1.0.0')) ? undefined : true
        },
        local: true,
        score: {
          final: 1,
          detail: {
            quality: 1,
            popularity: 1,
            maintenance: 0
          }
        },
        searchScore: 100000
      };
    } else {
      return pkg;
    }
  });
  const checkAccessPromises = await Promise.all(removeDuplicates(resultsCollection).map(pkgItem => {
    return checkAccess(pkgItem, auth, req.remote_user);
  }));
  const final = checkAccessPromises.filter(i => !_lodash.default.isNull(i)).slice(from, size);
  _logger.logger.debug(`search results ${final === null || final === void 0 ? void 0 : final.length}`);
  const response = {
    objects: final,
    total: final.length,
    time: new Date().toUTCString()
  };
  _logger.logger.debug(`total response ${final.length}`);
  return response;
}

/**
 * Endpoint for npm search v1
 * req: 'GET /-/v1/search?text=react&size=20&from=0&quality=0.65&popularity=0.98&maintenance=0.5'
 */
function _default(route, auth, storage) {
  route.get('/-/v1/search', async (req, res, next) => {
    // TODO: implement proper result scoring weighted by quality, popularity and maintenance query parameters
    let [text, size, from /* , quality, popularity, maintenance */] = ['text', 'size', 'from' /* , 'quality', 'popularity', 'maintenance' */].map(k => req.query[k]);
    size = parseInt(size) || 20;
    from = parseInt(from) || 0;
    const isInteresting = compileTextSearch(text);
    const resultStream = storage.search(0, {
      req
    });
    let resultBuf = [];
    let completed = false;
    resultStream.on('data', pkg => {
      // packages from the upstreams
      if (_lodash.default.isArray(pkg)) {
        resultBuf = resultBuf.concat(pkg.filter(pkgItem => {
          var _pkgItem$package;
          if (!isInteresting(pkgItem === null || pkgItem === void 0 ? void 0 : pkgItem.package)) {
            return;
          }
          _logger.logger.debug(`[remote] pkg name ${pkgItem === null || pkgItem === void 0 ? void 0 : (_pkgItem$package = pkgItem.package) === null || _pkgItem$package === void 0 ? void 0 : _pkgItem$package.name}`);
          return true;
        }));
      } else {
        // packages from local
        // due compability with `/-/all` we cannot refactor storage.search();
        if (!isInteresting(pkg)) {
          return;
        }
        _logger.logger.debug(`[local] pkg name ${pkg === null || pkg === void 0 ? void 0 : pkg.name}`);
        resultBuf.push(pkg);
      }
    });
    resultStream.on('error', function () {
      _logger.logger.error('search endpoint has failed');
      res.socket.destroy();
    });
    resultStream.on('end', async () => {
      if (!completed) {
        completed = true;
        try {
          const response = await sendResponse(resultBuf, resultStream, auth, req, from, size);
          _logger.logger.info('search endpoint ok results @{total}', {
            total: response.total
          });
          res.status(_constants.HTTP_STATUS.OK).json(response);
        } catch (err) {
          _logger.logger.error('search endpoint has failed @{err}', {
            err
          });
          next(err);
        }
      }
    });
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJwZXJzb25NYXRjaCIsInBlcnNvbiIsInNlYXJjaCIsImluY2x1ZGVzIiwiZmllbGQiLCJPYmplY3QiLCJ2YWx1ZXMiLCJtYXRjaGVyIiwicXVlcnkiLCJtYXRjaCIsInBrZyIsImF1dGhvciIsIm1hcCIsImsiLCJmaWx0ZXIiLCJ4IiwidW5kZWZpbmVkIiwic29tZSIsInR4dCIsImNvbXBpbGVUZXh0U2VhcmNoIiwidGV4dFNlYXJjaCIsInRleHRNYXRjaGVycyIsInNwbGl0IiwiZXZlcnkiLCJtIiwicmVtb3ZlRHVwbGljYXRlcyIsInJlc3VsdHMiLCJwa2dOYW1lcyIsInBhY2thZ2UiLCJuYW1lIiwicHVzaCIsImNoZWNrQWNjZXNzIiwiYXV0aCIsInJlbW90ZVVzZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImFsbG93X2FjY2VzcyIsInBhY2thZ2VOYW1lIiwiZXJyIiwiYWxsb3dlZCIsInN0YXR1cyIsIlN0cmluZyIsInNlbmRSZXNwb25zZSIsInJlc3VsdEJ1ZiIsInJlc3VsdFN0cmVhbSIsInJlcSIsImZyb20iLCJzaXplIiwiZGVzdHJveSIsInJlc3VsdHNDb2xsZWN0aW9uIiwiZmxhZ3MiLCJ1bnN0YWJsZSIsImtleXMiLCJ2ZXJzaW9ucyIsInYiLCJzZW12ZXIiLCJzYXRpc2ZpZXMiLCJsb2NhbCIsInNjb3JlIiwiZmluYWwiLCJkZXRhaWwiLCJxdWFsaXR5IiwicG9wdWxhcml0eSIsIm1haW50ZW5hbmNlIiwic2VhcmNoU2NvcmUiLCJjaGVja0FjY2Vzc1Byb21pc2VzIiwiYWxsIiwicGtnSXRlbSIsInJlbW90ZV91c2VyIiwiaSIsIl8iLCJpc051bGwiLCJzbGljZSIsImxvZ2dlciIsImRlYnVnIiwibGVuZ3RoIiwicmVzcG9uc2UiLCJvYmplY3RzIiwidG90YWwiLCJ0aW1lIiwiRGF0ZSIsInRvVVRDU3RyaW5nIiwicm91dGUiLCJzdG9yYWdlIiwiZ2V0IiwicmVzIiwibmV4dCIsInRleHQiLCJwYXJzZUludCIsImlzSW50ZXJlc3RpbmciLCJjb21wbGV0ZWQiLCJvbiIsImlzQXJyYXkiLCJjb25jYXQiLCJlcnJvciIsInNvY2tldCIsImluZm8iLCJIVFRQX1NUQVRVUyIsIk9LIiwianNvbiJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9hcGkvZW5kcG9pbnQvYXBpL3YxL3NlYXJjaC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuXG5pbXBvcnQgeyBQYWNrYWdlIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5cbmltcG9ydCB7IEhUVFBfU1RBVFVTIH0gZnJvbSAnLi4vLi4vLi4vLi4vbGliL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi8uLi8uLi8uLi9saWIvbG9nZ2VyJztcblxudHlwZSBQdWJsaXNoZXJNYWludGFpbmVyID0ge1xuICB1c2VybmFtZTogc3RyaW5nO1xuICBlbWFpbDogc3RyaW5nO1xufTtcblxudHlwZSBQYWNrYWdlUmVzdWx0cyA9IHtcbiAgbmFtZTogc3RyaW5nO1xuICBzY29wZTogc3RyaW5nO1xuICB2ZXJzaW9uOiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gIGRhdGU6IHN0cmluZztcbiAgbGlua3M6IHtcbiAgICBucG06IHN0cmluZztcbiAgICBob21lcGFnZT86IHN0cmluZztcbiAgICByZXBvc2l0b3J5Pzogc3RyaW5nO1xuICAgIGJ1Z3M/OiBzdHJpbmc7XG4gIH07XG4gIGF1dGhvcjogeyBuYW1lOiBzdHJpbmcgfTtcbiAgcHVibGlzaGVyOiBQdWJsaXNoZXJNYWludGFpbmVyO1xuICBtYWludGFpbmVyOiBQdWJsaXNoZXJNYWludGFpbmVyO1xufTtcblxudHlwZSBTZWFyY2hSZXN1bHQgPSB7XG4gIHBhY2thZ2U6IFBhY2thZ2VSZXN1bHRzO1xuICBmbGFncz86IHsgdW5zdGFibGU6IGJvb2xlYW4gfCB2b2lkIH07XG4gIGxvY2FsPzogYm9vbGVhbjtcbiAgc2NvcmU6IHtcbiAgICBmaW5hbDogbnVtYmVyO1xuICAgIGRldGFpbDoge1xuICAgICAgcXVhbGl0eTogbnVtYmVyO1xuICAgICAgcG9wdWxhcml0eTogbnVtYmVyO1xuICAgICAgbWFpbnRlbmFuY2U6IG51bWJlcjtcbiAgICB9O1xuICB9O1xuICBzZWFyY2hTY29yZTogbnVtYmVyO1xufTtcblxudHlwZSBTZWFyY2hSZXN1bHRzID0ge1xuICBvYmplY3RzOiBTZWFyY2hSZXN1bHRbXTtcbiAgdG90YWw6IG51bWJlcjtcbiAgdGltZTogc3RyaW5nO1xufTtcblxuY29uc3QgcGVyc29uTWF0Y2ggPSAocGVyc29uLCBzZWFyY2gpID0+IHtcbiAgaWYgKHR5cGVvZiBwZXJzb24gPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIHBlcnNvbi5pbmNsdWRlcyhzZWFyY2gpO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBwZXJzb24gPT09ICdvYmplY3QnKSB7XG4gICAgZm9yIChjb25zdCBmaWVsZCBvZiBPYmplY3QudmFsdWVzKHBlcnNvbikpIHtcbiAgICAgIGlmICh0eXBlb2YgZmllbGQgPT09ICdzdHJpbmcnICYmIGZpZWxkLmluY2x1ZGVzKHNlYXJjaCkpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGZhbHNlO1xufTtcblxuY29uc3QgbWF0Y2hlciA9IGZ1bmN0aW9uIChxdWVyeSkge1xuICBjb25zdCBtYXRjaCA9IHF1ZXJ5Lm1hdGNoKC9hdXRob3I6KC4qKS8pO1xuICBpZiAobWF0Y2ggIT09IG51bGwpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKHBrZykge1xuICAgICAgcmV0dXJuIHBlcnNvbk1hdGNoKHBrZy5hdXRob3IsIG1hdGNoWzFdKTtcbiAgICB9O1xuICB9XG5cbiAgLy8gVE9ETzogbWFpbnRhaW5lciwga2V5d29yZHMsIGJvb3N0LWV4YWN0XG4gIC8vIFRPRE8gaW1wbGVtZW50IHNvbWUgc2NvcmluZyBzeXN0ZW0gZm9yIGZyZWV0ZXh0XG4gIHJldHVybiAocGtnKSA9PiB7XG4gICAgcmV0dXJuIFsnbmFtZScsICdkaXNwbGF5TmFtZScsICdkZXNjcmlwdGlvbiddXG4gICAgICAubWFwKChrKSA9PiB7XG4gICAgICAgIHJldHVybiBwa2dba107XG4gICAgICB9KVxuICAgICAgLmZpbHRlcigoeCkgPT4ge1xuICAgICAgICByZXR1cm4geCAhPT0gdW5kZWZpbmVkO1xuICAgICAgfSlcbiAgICAgIC5zb21lKCh0eHQpID0+IHtcbiAgICAgICAgcmV0dXJuIHR4dC5pbmNsdWRlcyhxdWVyeSk7XG4gICAgICB9KTtcbiAgfTtcbn07XG5cbmZ1bmN0aW9uIGNvbXBpbGVUZXh0U2VhcmNoKHRleHRTZWFyY2g6IHN0cmluZyk6IChwa2c6IFBhY2thZ2VSZXN1bHRzKSA9PiBib29sZWFuIHtcbiAgY29uc3QgdGV4dE1hdGNoZXJzID0gKHRleHRTZWFyY2ggfHwgJycpLnNwbGl0KCcgJykubWFwKG1hdGNoZXIpO1xuICByZXR1cm4gKHBrZykgPT4gdGV4dE1hdGNoZXJzLmV2ZXJ5KChtKSA9PiBtKHBrZykpO1xufVxuXG5mdW5jdGlvbiByZW1vdmVEdXBsaWNhdGVzKHJlc3VsdHMpIHtcbiAgY29uc3QgcGtnTmFtZXM6IGFueVtdID0gW107XG4gIHJldHVybiByZXN1bHRzLmZpbHRlcigocGtnKSA9PiB7XG4gICAgaWYgKHBrZ05hbWVzLmluY2x1ZGVzKHBrZz8ucGFja2FnZT8ubmFtZSkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcGtnTmFtZXMucHVzaChwa2c/LnBhY2thZ2U/Lm5hbWUpO1xuICAgIHJldHVybiB0cnVlO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY2hlY2tBY2Nlc3MocGtnOiBhbnksIGF1dGg6IGFueSwgcmVtb3RlVXNlcik6IFByb21pc2U8UGFja2FnZSB8IG51bGw+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBhdXRoLmFsbG93X2FjY2Vzcyh7IHBhY2thZ2VOYW1lOiBwa2c/LnBhY2thZ2U/Lm5hbWUgfSwgcmVtb3RlVXNlciwgZnVuY3Rpb24gKGVyciwgYWxsb3dlZCkge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBpZiAoZXJyLnN0YXR1cyAmJiBTdHJpbmcoZXJyLnN0YXR1cykubWF0Y2goL140XFxkXFxkJC8pKSB7XG4gICAgICAgICAgLy8gYXV0aCBwbHVnaW4gcmV0dXJucyA0eHggdXNlciBlcnJvcixcbiAgICAgICAgICAvLyB0aGF0J3MgZXF1aXZhbGVudCBvZiAhYWxsb3dlZCBiYXNpY2FsbHlcbiAgICAgICAgICBhbGxvd2VkID0gZmFsc2U7XG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUobnVsbCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXNvbHZlKGFsbG93ZWQgPyBwa2cgOiBudWxsKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlbmRSZXNwb25zZShcbiAgcmVzdWx0QnVmLFxuICByZXN1bHRTdHJlYW0sXG4gIGF1dGgsXG4gIHJlcSxcbiAgZnJvbTogbnVtYmVyLFxuICBzaXplOiBudW1iZXJcbik6IFByb21pc2U8U2VhcmNoUmVzdWx0cz4ge1xuICByZXN1bHRTdHJlYW0uZGVzdHJveSgpO1xuICBjb25zdCByZXN1bHRzQ29sbGVjdGlvbiA9IHJlc3VsdEJ1Zi5tYXAoKHBrZyk6IFNlYXJjaFJlc3VsdCA9PiB7XG4gICAgaWYgKHBrZz8ubmFtZSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGFja2FnZTogcGtnLFxuICAgICAgICAvLyBub3Qgc3VyZSBpZiBmbGFncyBpcyBuZWVkIGl0XG4gICAgICAgIGZsYWdzOiB7XG4gICAgICAgICAgdW5zdGFibGU6IE9iamVjdC5rZXlzKHBrZy52ZXJzaW9ucykuc29tZSgodikgPT4gc2VtdmVyLnNhdGlzZmllcyh2LCAnXjEuMC4wJykpXG4gICAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgICAgOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgICBsb2NhbDogdHJ1ZSxcbiAgICAgICAgc2NvcmU6IHtcbiAgICAgICAgICBmaW5hbDogMSxcbiAgICAgICAgICBkZXRhaWw6IHtcbiAgICAgICAgICAgIHF1YWxpdHk6IDEsXG4gICAgICAgICAgICBwb3B1bGFyaXR5OiAxLFxuICAgICAgICAgICAgbWFpbnRlbmFuY2U6IDAsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgc2VhcmNoU2NvcmU6IDEwMDAwMCxcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBwa2c7XG4gICAgfVxuICB9KTtcbiAgY29uc3QgY2hlY2tBY2Nlc3NQcm9taXNlczogU2VhcmNoUmVzdWx0W10gPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICByZW1vdmVEdXBsaWNhdGVzKHJlc3VsdHNDb2xsZWN0aW9uKS5tYXAoKHBrZ0l0ZW0pID0+IHtcbiAgICAgIHJldHVybiBjaGVja0FjY2Vzcyhwa2dJdGVtLCBhdXRoLCByZXEucmVtb3RlX3VzZXIpO1xuICAgIH0pXG4gICk7XG5cbiAgY29uc3QgZmluYWw6IFNlYXJjaFJlc3VsdFtdID0gY2hlY2tBY2Nlc3NQcm9taXNlcy5maWx0ZXIoKGkpID0+ICFfLmlzTnVsbChpKSkuc2xpY2UoZnJvbSwgc2l6ZSk7XG4gIGxvZ2dlci5kZWJ1Zyhgc2VhcmNoIHJlc3VsdHMgJHtmaW5hbD8ubGVuZ3RofWApO1xuXG4gIGNvbnN0IHJlc3BvbnNlOiBTZWFyY2hSZXN1bHRzID0ge1xuICAgIG9iamVjdHM6IGZpbmFsLFxuICAgIHRvdGFsOiBmaW5hbC5sZW5ndGgsXG4gICAgdGltZTogbmV3IERhdGUoKS50b1VUQ1N0cmluZygpLFxuICB9O1xuXG4gIGxvZ2dlci5kZWJ1ZyhgdG90YWwgcmVzcG9uc2UgJHtmaW5hbC5sZW5ndGh9YCk7XG4gIHJldHVybiByZXNwb25zZTtcbn1cblxuLyoqXG4gKiBFbmRwb2ludCBmb3IgbnBtIHNlYXJjaCB2MVxuICogcmVxOiAnR0VUIC8tL3YxL3NlYXJjaD90ZXh0PXJlYWN0JnNpemU9MjAmZnJvbT0wJnF1YWxpdHk9MC42NSZwb3B1bGFyaXR5PTAuOTgmbWFpbnRlbmFuY2U9MC41J1xuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiAocm91dGUsIGF1dGgsIHN0b3JhZ2UpOiB2b2lkIHtcbiAgcm91dGUuZ2V0KCcvLS92MS9zZWFyY2gnLCBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAvLyBUT0RPOiBpbXBsZW1lbnQgcHJvcGVyIHJlc3VsdCBzY29yaW5nIHdlaWdodGVkIGJ5IHF1YWxpdHksIHBvcHVsYXJpdHkgYW5kIG1haW50ZW5hbmNlIHF1ZXJ5IHBhcmFtZXRlcnNcbiAgICBsZXQgW3RleHQsIHNpemUsIGZyb20gLyogLCBxdWFsaXR5LCBwb3B1bGFyaXR5LCBtYWludGVuYW5jZSAqL10gPSBbXG4gICAgICAndGV4dCcsXG4gICAgICAnc2l6ZScsXG4gICAgICAnZnJvbScgLyogLCAncXVhbGl0eScsICdwb3B1bGFyaXR5JywgJ21haW50ZW5hbmNlJyAqLyxcbiAgICBdLm1hcCgoaykgPT4gcmVxLnF1ZXJ5W2tdKTtcblxuICAgIHNpemUgPSBwYXJzZUludChzaXplKSB8fCAyMDtcbiAgICBmcm9tID0gcGFyc2VJbnQoZnJvbSkgfHwgMDtcblxuICAgIGNvbnN0IGlzSW50ZXJlc3RpbmcgPSBjb21waWxlVGV4dFNlYXJjaCh0ZXh0KTtcblxuICAgIGNvbnN0IHJlc3VsdFN0cmVhbSA9IHN0b3JhZ2Uuc2VhcmNoKDAsIHsgcmVxIH0pO1xuICAgIGxldCByZXN1bHRCdWYgPSBbXSBhcyBhbnk7XG4gICAgbGV0IGNvbXBsZXRlZCA9IGZhbHNlO1xuXG4gICAgcmVzdWx0U3RyZWFtLm9uKCdkYXRhJywgKHBrZzogU2VhcmNoUmVzdWx0W10gfCBQYWNrYWdlUmVzdWx0cykgPT4ge1xuICAgICAgLy8gcGFja2FnZXMgZnJvbSB0aGUgdXBzdHJlYW1zXG4gICAgICBpZiAoXy5pc0FycmF5KHBrZykpIHtcbiAgICAgICAgcmVzdWx0QnVmID0gcmVzdWx0QnVmLmNvbmNhdChcbiAgICAgICAgICAocGtnIGFzIFNlYXJjaFJlc3VsdFtdKS5maWx0ZXIoKHBrZ0l0ZW0pID0+IHtcbiAgICAgICAgICAgIGlmICghaXNJbnRlcmVzdGluZyhwa2dJdGVtPy5wYWNrYWdlKSkge1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoYFtyZW1vdGVdIHBrZyBuYW1lICR7cGtnSXRlbT8ucGFja2FnZT8ubmFtZX1gKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBwYWNrYWdlcyBmcm9tIGxvY2FsXG4gICAgICAgIC8vIGR1ZSBjb21wYWJpbGl0eSB3aXRoIGAvLS9hbGxgIHdlIGNhbm5vdCByZWZhY3RvciBzdG9yYWdlLnNlYXJjaCgpO1xuICAgICAgICBpZiAoIWlzSW50ZXJlc3RpbmcocGtnKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBsb2dnZXIuZGVidWcoYFtsb2NhbF0gcGtnIG5hbWUgJHsocGtnIGFzIFBhY2thZ2VSZXN1bHRzKT8ubmFtZX1gKTtcbiAgICAgICAgcmVzdWx0QnVmLnB1c2gocGtnKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJlc3VsdFN0cmVhbS5vbignZXJyb3InLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ3NlYXJjaCBlbmRwb2ludCBoYXMgZmFpbGVkJyk7XG4gICAgICByZXMuc29ja2V0LmRlc3Ryb3koKTtcbiAgICB9KTtcblxuICAgIHJlc3VsdFN0cmVhbS5vbignZW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgaWYgKCFjb21wbGV0ZWQpIHtcbiAgICAgICAgY29tcGxldGVkID0gdHJ1ZTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHNlbmRSZXNwb25zZShyZXN1bHRCdWYsIHJlc3VsdFN0cmVhbSwgYXV0aCwgcmVxLCBmcm9tLCBzaXplKTtcbiAgICAgICAgICBsb2dnZXIuaW5mbygnc2VhcmNoIGVuZHBvaW50IG9rIHJlc3VsdHMgQHt0b3RhbH0nLCB7IHRvdGFsOiByZXNwb25zZS50b3RhbCB9KTtcbiAgICAgICAgICByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk9LKS5qc29uKHJlc3BvbnNlKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKCdzZWFyY2ggZW5kcG9pbnQgaGFzIGZhaWxlZCBAe2Vycn0nLCB7IGVyciB9KTtcbiAgICAgICAgICBuZXh0KGVycik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBO0FBQ0E7QUFJQTtBQUNBO0FBQWdEO0FBNkNoRCxNQUFNQSxXQUFXLEdBQUcsQ0FBQ0MsTUFBTSxFQUFFQyxNQUFNLEtBQUs7RUFDdEMsSUFBSSxPQUFPRCxNQUFNLEtBQUssUUFBUSxFQUFFO0lBQzlCLE9BQU9BLE1BQU0sQ0FBQ0UsUUFBUSxDQUFDRCxNQUFNLENBQUM7RUFDaEM7RUFFQSxJQUFJLE9BQU9ELE1BQU0sS0FBSyxRQUFRLEVBQUU7SUFDOUIsS0FBSyxNQUFNRyxLQUFLLElBQUlDLE1BQU0sQ0FBQ0MsTUFBTSxDQUFDTCxNQUFNLENBQUMsRUFBRTtNQUN6QyxJQUFJLE9BQU9HLEtBQUssS0FBSyxRQUFRLElBQUlBLEtBQUssQ0FBQ0QsUUFBUSxDQUFDRCxNQUFNLENBQUMsRUFBRTtRQUN2RCxPQUFPLElBQUk7TUFDYjtJQUNGO0VBQ0Y7RUFFQSxPQUFPLEtBQUs7QUFDZCxDQUFDO0FBRUQsTUFBTUssT0FBTyxHQUFHLFVBQVVDLEtBQUssRUFBRTtFQUMvQixNQUFN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