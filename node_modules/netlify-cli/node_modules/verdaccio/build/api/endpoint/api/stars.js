"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;
var _lodash = _interopRequireDefault(require("lodash"));
var _core = require("@verdaccio/core");
var _constants = require("../../../lib/constants");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function _default(route, storage) {
  route.get('/-/_view/starredByUser', (req, res, next) => {
    // @ts-ignore
    const query = req.query;
    if (typeof (query === null || query === void 0 ? void 0 : query.key) !== 'string') {
      return next(_core.errorUtils.getBadRequest('missing query key username'));
    }

    // @ts-ignore
    storage.getLocalDatabase((err, localPackages) => {
      if (err) {
        return next(err);
      }
      const filteredPackages = localPackages.filter(localPackage => _lodash.default.keys(localPackage[_constants.USERS]).includes(query === null || query === void 0 ? void 0 : query.key.toString().replace(/['"]+/g, '')));
      res.status(_constants.HTTP_STATUS.OK);
      next({
        rows: filteredPackages.map(filteredPackage => ({
          value: filteredPackage.name
        }))
      });
    });
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJyb3V0ZSIsInN0b3JhZ2UiLCJnZXQiLCJyZXEiLCJyZXMiLCJuZXh0IiwicXVlcnkiLCJrZXkiLCJlcnJvclV0aWxzIiwiZ2V0QmFkUmVxdWVzdCIsImdldExvY2FsRGF0YWJhc2UiLCJlcnIiLCJsb2NhbFBhY2thZ2VzIiwiZmlsdGVyZWRQYWNrYWdlcyIsImZpbHRlciIsImxvY2FsUGFja2FnZSIsIl8iLCJrZXlzIiwiVVNFUlMiLCJpbmNsdWRlcyIsInRvU3RyaW5nIiwicmVwbGFjZSIsInN0YXR1cyIsIkhUVFBfU1RBVFVTIiwiT0siLCJyb3dzIiwibWFwIiwiZmlsdGVyZWRQYWNrYWdlIiwidmFsdWUiLCJuYW1lIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2FwaS9lbmRwb2ludC9hcGkvc3RhcnMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVzcG9uc2UsIFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHsgZXJyb3JVdGlscyB9IGZyb20gJ0B2ZXJkYWNjaW8vY29yZSc7XG5pbXBvcnQgeyBNYW5pZmVzdCwgVmVyc2lvbiB9IGZyb20gJ0B2ZXJkYWNjaW8vdHlwZXMnO1xuXG5pbXBvcnQgeyBIVFRQX1NUQVRVUywgVVNFUlMgfSBmcm9tICcuLi8uLi8uLi9saWIvY29uc3RhbnRzJztcbmltcG9ydCB7ICROZXh0RnVuY3Rpb25WZXIsICRSZXF1ZXN0RXh0ZW5kLCBJU3RvcmFnZUhhbmRsZXIgfSBmcm9tICcuLi8uLi8uLi90eXBlcyc7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChyb3V0ZTogUm91dGVyLCBzdG9yYWdlOiBJU3RvcmFnZUhhbmRsZXIpOiB2b2lkIHtcbiAgcm91dGUuZ2V0KFxuICAgICcvLS9fdmlldy9zdGFycmVkQnlVc2VyJyxcbiAgICAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiBSZXNwb25zZSwgbmV4dDogJE5leHRGdW5jdGlvblZlcik6IHZvaWQgPT4ge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgY29uc3QgcXVlcnk6IHsga2V5OiBzdHJpbmcgfSA9IHJlcS5xdWVyeTtcbiAgICAgIGlmICh0eXBlb2YgcXVlcnk/LmtleSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIG5leHQoZXJyb3JVdGlscy5nZXRCYWRSZXF1ZXN0KCdtaXNzaW5nIHF1ZXJ5IGtleSB1c2VybmFtZScpKTtcbiAgICAgIH1cblxuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgc3RvcmFnZS5nZXRMb2NhbERhdGFiYXNlKChlcnIsIGxvY2FsUGFja2FnZXM6IFZlcnNpb25bXSkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIG5leHQoZXJyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGZpbHRlcmVkUGFja2FnZXM6IFZlcnNpb25bXSA9IGxvY2FsUGFja2FnZXMuZmlsdGVyKChsb2NhbFBhY2thZ2U6IFZlcnNpb24pID0+XG4gICAgICAgICAgXy5rZXlzKGxvY2FsUGFja2FnZVtVU0VSU10pLmluY2x1ZGVzKHF1ZXJ5Py5rZXkudG9TdHJpbmcoKS5yZXBsYWNlKC9bJ1wiXSsvZywgJycpKVxuICAgICAgICApO1xuXG4gICAgICAgIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuT0spO1xuICAgICAgICBuZXh0KHtcbiAgICAgICAgICByb3dzOiBmaWx0ZXJlZFBhY2thZ2VzLm1hcCgoZmlsdGVyZWRQYWNrYWdlOiBWZXJzaW9uKSA9PiAoe1xuICAgICAgICAgICAgdmFsdWU6IGZpbHRlcmVkUGFja2FnZS5uYW1lLFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gICk7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBO0FBRUE7QUFHQTtBQUE0RDtBQUc3QyxrQkFBVUEsS0FBYSxFQUFFQyxPQUF3QixFQUFRO0VBQ3RFRCxLQUFLLENBQUNFLEdBQUcsQ0FDUCx3QkFBd0IsRUFDeEIsQ0FBQ0MsR0FBbUIsRUFBRUMsR0FBYSxFQUFFQyxJQUFzQixLQUFXO0lBQ3BFO0lBQ0EsTUFBTUMsS0FBc0IsR0FBR0gsR0FBRyxDQUFDRyxLQUFLO0lBQ3hDLElBQUksUUFBT0EsS0FBSyxhQUFMQSxLQUFLLHVCQUFMQSxLQUFLLENBQUVDLEdBQUcsTUFBSyxRQUFRLEVBQUU7TUFDbEMsT0FBT0YsSUFBSSxDQUFDRyxnQkFBVSxDQUFDQyxhQUFhLENBQUMsNEJBQTRCLENBQUMsQ0FBQztJQUNyRTs7SUFFQTtJQUNBUixPQUFPLENBQUNTLGdCQUFnQixDQUFDLENBQUNDLEdBQUcsRUFBRUMsYUFBd0IsS0FBSztNQUMxRCxJQUFJRCxHQUFHLEVBQUU7UUFDUCxPQUFPTixJQUFJLENBQUNNLEdBQUcsQ0FBQztNQUNsQjtNQUVBLE1BQU1FLGdCQUEyQixHQUFHRCxhQUFhLENBQUNFLE1BQU0sQ0FBRUMsWUFBcUIsSUFDN0VDLGVBQUMsQ0FBQ0MsSUFBSSxDQUFDRixZQUFZLENBQUNHLGdCQUFLLENBQUMsQ0FBQyxDQUFDQyxRQUFRLENBQUNiLEtBQUssYUFBTEEsS0FBSyx1QkFBTEEsS0FBSyxDQUFFQyxHQUFHLENBQUNhLFFBQVEsRUFBRSxDQUFDQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQ2xGO01BRURqQixHQUFHLENBQUNrQixNQUFNLENBQUNDLHNCQUFXLENBQUNDLEVBQUUsQ0FBQztNQUMxQm5CLElBQUksQ0FBQztRQUNIb0IsSUFBSSxFQUFFWixnQkFBZ0IsQ0FBQ2EsR0FBRyxDQUFFQyxlQUF3QixLQUFNO1VBQ3hEQyxLQUFLLEVBQUVELGVBQWUsQ0FBQ0U7UUFDekIsQ0FBQyxDQUFDO01BQ0osQ0FBQyxDQUFDO0lBQ0osQ0FBQyxDQUFDO0VBQ0osQ0FBQyxDQUNGO0FBQ0gifQ==