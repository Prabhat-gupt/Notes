"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = loadPlugin;
var _debug = _interopRequireDefault(require("debug"));
var _lodash = _interopRequireDefault(require("lodash"));
var _path = _interopRequireDefault(require("path"));
var _constants = require("./constants");
var _logger = require("./logger");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const debug = (0, _debug.default)('verdaccio:plugin:loader');

/**
 * Requires a module.
 * @param {*} path the module's path
 * @return {Object}
 */
function tryLoad(path) {
  try {
    debug('loading plugin %s', path);
    return require(path);
  } catch (err) {
    if (err.code === _constants.MODULE_NOT_FOUND) {
      debug('plugin %s not found', path);
      return null;
    }
    _logger.logger.error({
      err: err.msg
    }, 'error loading plugin @{err}');
    throw err;
  }
}
function mergeConfig(appConfig, pluginConfig) {
  return _lodash.default.merge(appConfig, pluginConfig);
}
function isValid(plugin) {
  return _lodash.default.isFunction(plugin) || _lodash.default.isFunction(plugin.default);
}
function isES6(plugin) {
  return Object.keys(plugin).includes('default');
}

// export type PluginGeneric<R, T extends IPlugin<R> = ;

/**
 * Load a plugin following the rules
 * - First try to load from the internal directory plugins (which will disappear soon or later).
 * - If the package is scoped eg: @scope/foo, try to load as a package
 * - A second attempt from the external plugin directory
 * - A third attempt from node_modules, in case to have multiple match as for instance verdaccio-ldap
 * and sinopia-ldap. All verdaccio prefix will have preferences.
 * @param {*} config a reference of the configuration settings
 * @param {*} pluginConfigs
 * @param {*} params a set of params to initialize the plugin
 * @param {*} sanityCheck callback that check the shape that should fulfill the plugin
 * @return {Array} list of plugins
 */
function loadPlugin(config, pluginConfigs = {}, params, sanityCheck, prefix = 'verdaccio') {
  return Object.keys(pluginConfigs).map(pluginId => {
    let plugin;
    const isScoped = pluginId.startsWith('@') && pluginId.includes('/');
    debug('isScoped %s', isScoped);
    if (isScoped) {
      plugin = tryLoad(pluginId);
    }
    const localPlugin = _path.default.resolve(__dirname + '/../plugins', pluginId);
    // try local plugins first
    plugin = tryLoad(localPlugin);

    // try the external plugin directory
    if (plugin === null && config.plugins) {
      const pluginDir = config.plugins;
      const externalFilePlugin = _path.default.resolve(pluginDir, pluginId);
      plugin = tryLoad(externalFilePlugin);

      // npm package
      if (plugin === null && pluginId.match(/^[^\.\/]/)) {
        plugin = tryLoad(_path.default.resolve(pluginDir, `${prefix}-${pluginId}`));
        // compatibility for old sinopia plugins
        if (!plugin) {
          plugin = tryLoad(_path.default.resolve(pluginDir, `sinopia-${pluginId}`));
          if (plugin) {
            _logger.logger.warn({
              name: pluginId
            }, `plugin names that start with sinopia-* will be removed in the future, please rename package to verdaccio-*`);
          }
        }
      }
    }

    // npm package
    if (plugin === null && pluginId.match(/^[^\.\/]/)) {
      plugin = tryLoad(`${prefix}-${pluginId}`);
      // compatibility for old sinopia plugins
      if (!plugin) {
        plugin = tryLoad(`sinopia-${pluginId}`);
      }
      if (plugin) {
        debug('plugin %s is an npm package', pluginId);
      }
    }
    if (plugin === null) {
      plugin = tryLoad(pluginId);
    }

    // relative to config path
    if (plugin === null && pluginId.match(/^\.\.?($|\/)/)) {
      plugin = tryLoad(_path.default.resolve(_path.default.dirname(config.self_path), pluginId));
    }
    if (plugin === null) {
      if (isScoped) {
        _logger.logger.error({
          content: pluginId
        }, 'plugin not found. try npm install @{content}');
      } else {
        _logger.logger.error({
          content: pluginId,
          prefix
        }, 'plugin not found. try npm install @{prefix}-@{content}');
      }
      const msg = isScoped ? `
      ${pluginId} plugin not found. try "npm install ${pluginId}"` : `
      ${prefix}-${pluginId} plugin not found. try "npm install ${prefix}-${pluginId}"`;
      throw Error(msg);
    }
    if (!isValid(plugin)) {
      _logger.logger.error({
        content: pluginId
      }, '@{prefix}-@{content} plugin does not have the right code structure');
      throw Error(`"${pluginId}" plugin does not have the right code structure`);
    }

    /* eslint new-cap:off */
    try {
      if (isES6(plugin)) {
        debug('plugin is ES6');
        plugin = new plugin.default(mergeConfig(config, pluginConfigs[pluginId]), params);
      } else {
        debug('plugin is commonJS');
        plugin = plugin(pluginConfigs[pluginId], params);
      }
    } catch (error) {
      plugin = null;
      _logger.logger.error({
        error,
        pluginId
      }, 'error loading a plugin @{pluginId}: @{error}');
    }
    /* eslint new-cap:off */

    if (plugin === null || !sanityCheck(plugin)) {
      if (isScoped) {
        _logger.logger.error({
          content: pluginId
        }, "@{content} doesn't look like a valid plugin");
      } else {
        _logger.logger.error({
          content: pluginId,
          prefix
        }, "@{prefix}-@{content} doesn't look like a valid plugin");
      }
      throw Error(`sanity check has failed, "${pluginId}" is not a valid plugin`);
    }
    if (isScoped) {
      _logger.logger.info({
        content: pluginId
      }, 'plugin successfully loaded: @{content}');
    } else {
      _logger.logger.info({
        content: pluginId,
        prefix
      }, 'plugin successfully loaded: @{prefix}-@{content}');
    }
    return plugin;
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkZWJ1ZyIsImJ1aWxkRGVidWciLCJ0cnlMb2FkIiwicGF0aCIsInJlcXVpcmUiLCJlcnIiLCJjb2RlIiwiTU9EVUxFX05PVF9GT1VORCIsImxvZ2dlciIsImVycm9yIiwibXNnIiwibWVyZ2VDb25maWciLCJhcHBDb25maWciLCJwbHVnaW5Db25maWciLCJfIiwibWVyZ2UiLCJpc1ZhbGlkIiwicGx1Z2luIiwiaXNGdW5jdGlvbiIsImRlZmF1bHQiLCJpc0VTNiIsIk9iamVjdCIsImtleXMiLCJpbmNsdWRlcyIsImxvYWRQbHVnaW4iLCJjb25maWciLCJwbHVnaW5Db25maWdzIiwicGFyYW1zIiwic2FuaXR5Q2hlY2siLCJwcmVmaXgiLCJtYXAiLCJwbHVnaW5JZCIsImlzU2NvcGVkIiwic3RhcnRzV2l0aCIsImxvY2FsUGx1Z2luIiwiUGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJwbHVnaW5zIiwicGx1Z2luRGlyIiwiZXh0ZXJuYWxGaWxlUGx1Z2luIiwibWF0Y2giLCJ3YXJuIiwibmFtZSIsImRpcm5hbWUiLCJzZWxmX3BhdGgiLCJjb250ZW50IiwiRXJyb3IiLCJpbmZvIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xpYi9wbHVnaW4tbG9hZGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBidWlsZERlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgUGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHsgQ29uZmlnLCBJUGx1Z2luIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5cbmltcG9ydCB7IE1PRFVMRV9OT1RfRk9VTkQgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuL2xvZ2dlcic7XG5cbmNvbnN0IGRlYnVnID0gYnVpbGREZWJ1ZygndmVyZGFjY2lvOnBsdWdpbjpsb2FkZXInKTtcblxuLyoqXG4gKiBSZXF1aXJlcyBhIG1vZHVsZS5cbiAqIEBwYXJhbSB7Kn0gcGF0aCB0aGUgbW9kdWxlJ3MgcGF0aFxuICogQHJldHVybiB7T2JqZWN0fVxuICovXG5mdW5jdGlvbiB0cnlMb2FkKHBhdGg6IHN0cmluZyk6IGFueSB7XG4gIHRyeSB7XG4gICAgZGVidWcoJ2xvYWRpbmcgcGx1Z2luICVzJywgcGF0aCk7XG4gICAgcmV0dXJuIHJlcXVpcmUocGF0aCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIuY29kZSA9PT0gTU9EVUxFX05PVF9GT1VORCkge1xuICAgICAgZGVidWcoJ3BsdWdpbiAlcyBub3QgZm91bmQnLCBwYXRoKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBsb2dnZXIuZXJyb3IoeyBlcnI6IGVyci5tc2cgfSwgJ2Vycm9yIGxvYWRpbmcgcGx1Z2luIEB7ZXJyfScpO1xuICAgIHRocm93IGVycjtcbiAgfVxufVxuXG5mdW5jdGlvbiBtZXJnZUNvbmZpZyhhcHBDb25maWcsIHBsdWdpbkNvbmZpZyk6IENvbmZpZyB7XG4gIHJldHVybiBfLm1lcmdlKGFwcENvbmZpZywgcGx1Z2luQ29uZmlnKTtcbn1cblxuZnVuY3Rpb24gaXNWYWxpZChwbHVnaW4pOiBib29sZWFuIHtcbiAgcmV0dXJuIF8uaXNGdW5jdGlvbihwbHVnaW4pIHx8IF8uaXNGdW5jdGlvbihwbHVnaW4uZGVmYXVsdCk7XG59XG5cbmZ1bmN0aW9uIGlzRVM2KHBsdWdpbik6IGJvb2xlYW4ge1xuICByZXR1cm4gT2JqZWN0LmtleXMocGx1Z2luKS5pbmNsdWRlcygnZGVmYXVsdCcpO1xufVxuXG4vLyBleHBvcnQgdHlwZSBQbHVnaW5HZW5lcmljPFIsIFQgZXh0ZW5kcyBJUGx1Z2luPFI+ID0gO1xuXG4vKipcbiAqIExvYWQgYSBwbHVnaW4gZm9sbG93aW5nIHRoZSBydWxlc1xuICogLSBGaXJzdCB0cnkgdG8gbG9hZCBmcm9tIHRoZSBpbnRlcm5hbCBkaXJlY3RvcnkgcGx1Z2lucyAod2hpY2ggd2lsbCBkaXNhcHBlYXIgc29vbiBvciBsYXRlcikuXG4gKiAtIElmIHRoZSBwYWNrYWdlIGlzIHNjb3BlZCBlZzogQHNjb3BlL2ZvbywgdHJ5IHRvIGxvYWQgYXMgYSBwYWNrYWdlXG4gKiAtIEEgc2Vjb25kIGF0dGVtcHQgZnJvbSB0aGUgZXh0ZXJuYWwgcGx1Z2luIGRpcmVjdG9yeVxuICogLSBBIHRoaXJkIGF0dGVtcHQgZnJvbSBub2RlX21vZHVsZXMsIGluIGNhc2UgdG8gaGF2ZSBtdWx0aXBsZSBtYXRjaCBhcyBmb3IgaW5zdGFuY2UgdmVyZGFjY2lvLWxkYXBcbiAqIGFuZCBzaW5vcGlhLWxkYXAuIEFsbCB2ZXJkYWNjaW8gcHJlZml4IHdpbGwgaGF2ZSBwcmVmZXJlbmNlcy5cbiAqIEBwYXJhbSB7Kn0gY29uZmlnIGEgcmVmZXJlbmNlIG9mIHRoZSBjb25maWd1cmF0aW9uIHNldHRpbmdzXG4gKiBAcGFyYW0geyp9IHBsdWdpbkNvbmZpZ3NcbiAqIEBwYXJhbSB7Kn0gcGFyYW1zIGEgc2V0IG9mIHBhcmFtcyB0byBpbml0aWFsaXplIHRoZSBwbHVnaW5cbiAqIEBwYXJhbSB7Kn0gc2FuaXR5Q2hlY2sgY2FsbGJhY2sgdGhhdCBjaGVjayB0aGUgc2hhcGUgdGhhdCBzaG91bGQgZnVsZmlsbCB0aGUgcGx1Z2luXG4gKiBAcmV0dXJuIHtBcnJheX0gbGlzdCBvZiBwbHVnaW5zXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGxvYWRQbHVnaW48VCBleHRlbmRzIElQbHVnaW48VD4+KFxuICBjb25maWc6IENvbmZpZyxcbiAgcGx1Z2luQ29uZmlnczogYW55ID0ge30sXG4gIHBhcmFtczogYW55LFxuICBzYW5pdHlDaGVjazogYW55LFxuICBwcmVmaXg6IHN0cmluZyA9ICd2ZXJkYWNjaW8nXG4pOiBhbnlbXSB7XG4gIHJldHVybiBPYmplY3Qua2V5cyhwbHVnaW5Db25maWdzKS5tYXAoKHBsdWdpbklkOiBzdHJpbmcpOiBJUGx1Z2luPFQ+ID0+IHtcbiAgICBsZXQgcGx1Z2luO1xuICAgIGNvbnN0IGlzU2NvcGVkOiBib29sZWFuID0gcGx1Z2luSWQuc3RhcnRzV2l0aCgnQCcpICYmIHBsdWdpbklkLmluY2x1ZGVzKCcvJyk7XG4gICAgZGVidWcoJ2lzU2NvcGVkICVzJywgaXNTY29wZWQpO1xuICAgIGlmIChpc1Njb3BlZCkge1xuICAgICAgcGx1Z2luID0gdHJ5TG9hZChwbHVnaW5JZCk7XG4gICAgfVxuXG4gICAgY29uc3QgbG9jYWxQbHVnaW4gPSBQYXRoLnJlc29sdmUoX19kaXJuYW1lICsgJy8uLi9wbHVnaW5zJywgcGx1Z2luSWQpO1xuICAgIC8vIHRyeSBsb2NhbCBwbHVnaW5zIGZpcnN0XG4gICAgcGx1Z2luID0gdHJ5TG9hZChsb2NhbFBsdWdpbik7XG5cbiAgICAvLyB0cnkgdGhlIGV4dGVybmFsIHBsdWdpbiBkaXJlY3RvcnlcbiAgICBpZiAocGx1Z2luID09PSBudWxsICYmIGNvbmZpZy5wbHVnaW5zKSB7XG4gICAgICBjb25zdCBwbHVnaW5EaXIgPSBjb25maWcucGx1Z2lucztcbiAgICAgIGNvbnN0IGV4dGVybmFsRmlsZVBsdWdpbiA9IFBhdGgucmVzb2x2ZShwbHVnaW5EaXIsIHBsdWdpbklkKTtcbiAgICAgIHBsdWdpbiA9IHRyeUxvYWQoZXh0ZXJuYWxGaWxlUGx1Z2luKTtcblxuICAgICAgLy8gbnBtIHBhY2thZ2VcbiAgICAgIGlmIChwbHVnaW4gPT09IG51bGwgJiYgcGx1Z2luSWQubWF0Y2goL15bXlxcLlxcL10vKSkge1xuICAgICAgICBwbHVnaW4gPSB0cnlMb2FkKFBhdGgucmVzb2x2ZShwbHVnaW5EaXIsIGAke3ByZWZpeH0tJHtwbHVnaW5JZH1gKSk7XG4gICAgICAgIC8vIGNvbXBhdGliaWxpdHkgZm9yIG9sZCBzaW5vcGlhIHBsdWdpbnNcbiAgICAgICAgaWYgKCFwbHVnaW4pIHtcbiAgICAgICAgICBwbHVnaW4gPSB0cnlMb2FkKFBhdGgucmVzb2x2ZShwbHVnaW5EaXIsIGBzaW5vcGlhLSR7cGx1Z2luSWR9YCkpO1xuICAgICAgICAgIGlmIChwbHVnaW4pIHtcbiAgICAgICAgICAgIGxvZ2dlci53YXJuKFxuICAgICAgICAgICAgICB7IG5hbWU6IHBsdWdpbklkIH0sXG4gICAgICAgICAgICAgIGBwbHVnaW4gbmFtZXMgdGhhdCBzdGFydCB3aXRoIHNpbm9waWEtKiB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIGZ1dHVyZSwgcGxlYXNlIHJlbmFtZSBwYWNrYWdlIHRvIHZlcmRhY2Npby0qYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBucG0gcGFja2FnZVxuICAgIGlmIChwbHVnaW4gPT09IG51bGwgJiYgcGx1Z2luSWQubWF0Y2goL15bXlxcLlxcL10vKSkge1xuICAgICAgcGx1Z2luID0gdHJ5TG9hZChgJHtwcmVmaXh9LSR7cGx1Z2luSWR9YCk7XG4gICAgICAvLyBjb21wYXRpYmlsaXR5IGZvciBvbGQgc2lub3BpYSBwbHVnaW5zXG4gICAgICBpZiAoIXBsdWdpbikge1xuICAgICAgICBwbHVnaW4gPSB0cnlMb2FkKGBzaW5vcGlhLSR7cGx1Z2luSWR9YCk7XG4gICAgICB9XG4gICAgICBpZiAocGx1Z2luKSB7XG4gICAgICAgIGRlYnVnKCdwbHVnaW4gJXMgaXMgYW4gbnBtIHBhY2thZ2UnLCBwbHVnaW5JZCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHBsdWdpbiA9PT0gbnVsbCkge1xuICAgICAgcGx1Z2luID0gdHJ5TG9hZChwbHVnaW5JZCk7XG4gICAgfVxuXG4gICAgLy8gcmVsYXRpdmUgdG8gY29uZmlnIHBhdGhcbiAgICBpZiAocGx1Z2luID09PSBudWxsICYmIHBsdWdpbklkLm1hdGNoKC9eXFwuXFwuPygkfFxcLykvKSkge1xuICAgICAgcGx1Z2luID0gdHJ5TG9hZChQYXRoLnJlc29sdmUoUGF0aC5kaXJuYW1lKGNvbmZpZy5zZWxmX3BhdGgpLCBwbHVnaW5JZCkpO1xuICAgIH1cblxuICAgIGlmIChwbHVnaW4gPT09IG51bGwpIHtcbiAgICAgIGlmIChpc1Njb3BlZCkge1xuICAgICAgICBsb2dnZXIuZXJyb3IoeyBjb250ZW50OiBwbHVnaW5JZCB9LCAncGx1Z2luIG5vdCBmb3VuZC4gdHJ5IG5wbSBpbnN0YWxsIEB7Y29udGVudH0nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgICB7IGNvbnRlbnQ6IHBsdWdpbklkLCBwcmVmaXggfSxcbiAgICAgICAgICAncGx1Z2luIG5vdCBmb3VuZC4gdHJ5IG5wbSBpbnN0YWxsIEB7cHJlZml4fS1Ae2NvbnRlbnR9J1xuICAgICAgICApO1xuICAgICAgfVxuICAgICAgY29uc3QgbXNnID0gaXNTY29wZWRcbiAgICAgICAgPyBgXG4gICAgICAke3BsdWdpbklkfSBwbHVnaW4gbm90IGZvdW5kLiB0cnkgXCJucG0gaW5zdGFsbCAke3BsdWdpbklkfVwiYFxuICAgICAgICA6IGBcbiAgICAgICR7cHJlZml4fS0ke3BsdWdpbklkfSBwbHVnaW4gbm90IGZvdW5kLiB0cnkgXCJucG0gaW5zdGFsbCAke3ByZWZpeH0tJHtwbHVnaW5JZH1cImA7XG4gICAgICB0aHJvdyBFcnJvcihtc2cpO1xuICAgIH1cblxuICAgIGlmICghaXNWYWxpZChwbHVnaW4pKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgIHsgY29udGVudDogcGx1Z2luSWQgfSxcbiAgICAgICAgJ0B7cHJlZml4fS1Ae2NvbnRlbnR9IHBsdWdpbiBkb2VzIG5vdCBoYXZlIHRoZSByaWdodCBjb2RlIHN0cnVjdHVyZSdcbiAgICAgICk7XG4gICAgICB0aHJvdyBFcnJvcihgXCIke3BsdWdpbklkfVwiIHBsdWdpbiBkb2VzIG5vdCBoYXZlIHRoZSByaWdodCBjb2RlIHN0cnVjdHVyZWApO1xuICAgIH1cblxuICAgIC8qIGVzbGludCBuZXctY2FwOm9mZiAqL1xuICAgIHRyeSB7XG4gICAgICBpZiAoaXNFUzYocGx1Z2luKSkge1xuICAgICAgICBkZWJ1ZygncGx1Z2luIGlzIEVTNicpO1xuICAgICAgICBwbHVnaW4gPSBuZXcgcGx1Z2luLmRlZmF1bHQobWVyZ2VDb25maWcoY29uZmlnLCBwbHVnaW5Db25maWdzW3BsdWdpbklkXSksIHBhcmFtcyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkZWJ1ZygncGx1Z2luIGlzIGNvbW1vbkpTJyk7XG4gICAgICAgIHBsdWdpbiA9IHBsdWdpbihwbHVnaW5Db25maWdzW3BsdWdpbklkXSwgcGFyYW1zKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcGx1Z2luID0gbnVsbDtcbiAgICAgIGxvZ2dlci5lcnJvcih7IGVycm9yLCBwbHVnaW5JZCB9LCAnZXJyb3IgbG9hZGluZyBhIHBsdWdpbiBAe3BsdWdpbklkfTogQHtlcnJvcn0nKTtcbiAgICB9XG4gICAgLyogZXNsaW50IG5ldy1jYXA6b2ZmICovXG5cbiAgICBpZiAocGx1Z2luID09PSBudWxsIHx8ICFzYW5pdHlDaGVjayhwbHVnaW4pKSB7XG4gICAgICBpZiAoaXNTY29wZWQpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKHsgY29udGVudDogcGx1Z2luSWQgfSwgXCJAe2NvbnRlbnR9IGRvZXNuJ3QgbG9vayBsaWtlIGEgdmFsaWQgcGx1Z2luXCIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKFxuICAgICAgICAgIHsgY29udGVudDogcGx1Z2luSWQsIHByZWZpeCB9LFxuICAgICAgICAgIFwiQHtwcmVmaXh9LUB7Y29udGVudH0gZG9lc24ndCBsb29rIGxpa2UgYSB2YWxpZCBwbHVnaW5cIlxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhyb3cgRXJyb3IoYHNhbml0eSBjaGVjayBoYXMgZmFpbGVkLCBcIiR7cGx1Z2luSWR9XCIgaXMgbm90IGEgdmFsaWQgcGx1Z2luYCk7XG4gICAgfVxuXG4gICAgaWYgKGlzU2NvcGVkKSB7XG4gICAgICBsb2dnZXIuaW5mbyh7IGNvbnRlbnQ6IHBsdWdpbklkIH0sICdwbHVnaW4gc3VjY2Vzc2Z1bGx5IGxvYWRlZDogQHtjb250ZW50fScpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuaW5mbyhcbiAgICAgICAgeyBjb250ZW50OiBwbHVnaW5JZCwgcHJlZml4IH0sXG4gICAgICAgICdwbHVnaW4gc3VjY2Vzc2Z1bGx5IGxvYWRlZDogQHtwcmVmaXh9LUB7Y29udGVudH0nXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gcGx1Z2luO1xuICB9KTtcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBSUE7QUFDQTtBQUFrQztBQUVsQyxNQUFNQSxLQUFLLEdBQUcsSUFBQUMsY0FBVSxFQUFDLHlCQUF5QixDQUFDOztBQUVuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBU0MsT0FBTyxDQUFDQyxJQUFZLEVBQU87RUFDbEMsSUFBSTtJQUNGSCxLQUFLLENBQUMsbUJBQW1CLEVBQUVHLElBQUksQ0FBQztJQUNoQyxPQUFPQyxPQUFPLENBQUNELElBQUksQ0FBQztFQUN0QixDQUFDLENBQUMsT0FBT0UsR0FBRyxFQUFFO0lBQ1osSUFBSUEsR0FBRyxDQUFDQyxJQUFJLEtBQUtDLDJCQUFnQixFQUFFO01BQ2pDUCxLQUFLLENBQUMscUJBQXFCLEVBQUVHLElBQUksQ0FBQztNQUNsQyxPQUFPLElBQUk7SUFDYjtJQUNBSyxjQUFNLENBQUNDLEtBQUssQ0FBQztNQUFFSixHQUFHLEVBQUVBLEdBQUcsQ0FBQ0s7SUFBSSxDQUFDLEVBQUUsNkJBQTZCLENBQUM7SUFDN0QsTUFBTUwsR0FBRztFQUNYO0FBQ0Y7QUFFQSxTQUFTTSxXQUFXLENBQUNDLFNBQVMsRUFBRUMsWUFBWSxFQUFVO0VBQ3BELE9BQU9DLGVBQUMsQ0FBQ0MsS0FBSyxDQUFDSCxTQUFTLEVBQUVDLFlBQVksQ0FBQztBQUN6QztBQUVBLFNBQVNHLE9BQU8sQ0FBQ0MsTUFBTSxFQUFXO0VBQ2hDLE9BQU9ILGVBQUMsQ0FBQ0ksVUFBVSxDQUFDRCxNQUFNLENBQUMsSUFBSUgsZUFBQyxDQUFDSSxVQUFVLENBQUNELE1BQU0sQ0FBQ0UsT0FBTyxDQUFD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