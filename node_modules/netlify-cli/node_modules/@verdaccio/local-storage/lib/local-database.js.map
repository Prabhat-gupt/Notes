{"version":3,"file":"local-database.js","names":["DEPRECATED_DB_NAME","DB_NAME","debug","buildDebug","LocalDatabase","TokenActions","constructor","config","logger","path","_buildStoragePath","locked","data","_fetchLocalPackages","_sync","getSecret","Promise","resolve","secret","setSecret","add","name","cb","list","indexOf","push","search","onPackage","onEnd","validateName","storages","_getCustomPackageLocalStorages","JSON","stringify","base","Path","dirname","self_path","self","storageKeys","Object","keys","async","eachSeries","storage","position","base2","join","storagePath","fs","readdir","err","files","file","includes","match","fileLocation","file2","packagePath","stat","stats","_","isNil","item","time","mtime","getTime","remove","get","getInternalError","error","pkgName","splice","totalItems","length","getPackageStorage","packageName","packageAccess","getMatchedPackagesSpec","_getLocalStoragePath","undefined","isString","packageStoragePath","LocalDriver","clean","packages","listPackagesConf","map","pkg","Error","folderName","mkdirp","sync","writeFileSync","globalConfigStorage","sinopiadbPath","_dbGenPath","accessSync","constants","F_OK","process","emitWarning","code","detail","noSuchFile","emptyDatabase","loadPrivatePackages","message"],"sources":["../src/local-database.ts"],"sourcesContent":["import fs from 'fs';\nimport Path from 'path';\n\nimport buildDebug from 'debug';\nimport _ from 'lodash';\nimport async from 'async';\nimport mkdirp from 'mkdirp';\nimport {\n  Callback,\n  Config,\n  IPackageStorage,\n  IPluginStorage,\n  LocalStorage,\n  Logger,\n  StorageList,\n} from '@verdaccio/types';\nimport { getInternalError } from '@verdaccio/commons-api';\n\nimport LocalDriver, { noSuchFile } from './local-fs';\nimport { loadPrivatePackages } from './pkg-utils';\nimport TokenActions from './token';\n\nconst DEPRECATED_DB_NAME = '.sinopia-db.json';\nconst DB_NAME = '.verdaccio-db.json';\n\nconst debug = buildDebug('verdaccio:plugin:local-storage');\n\nclass LocalDatabase extends TokenActions implements IPluginStorage<{}> {\n  public path: string;\n  public logger: Logger;\n  public data: LocalStorage;\n  public config: Config;\n  public locked: boolean;\n\n  public constructor(config: Config, logger: Logger) {\n    super(config);\n    this.config = config;\n    this.path = this._buildStoragePath(config);\n    this.logger = logger;\n    this.locked = false;\n    this.data = this._fetchLocalPackages();\n    this._sync();\n  }\n\n  public getSecret(): Promise<string> {\n    return Promise.resolve(this.data.secret);\n  }\n\n  public setSecret(secret: string): Promise<Error | null> {\n    return new Promise((resolve): void => {\n      this.data.secret = secret;\n\n      resolve(this._sync());\n    });\n  }\n\n  public add(name: string, cb: Callback): void {\n    if (this.data.list.indexOf(name) === -1) {\n      this.data.list.push(name);\n\n      debug('the private package %o has been added', name);\n      cb(this._sync());\n    } else {\n      debug('the private package %o was not added', name);\n      cb(null);\n    }\n  }\n\n  public search(\n    onPackage: Callback,\n    onEnd: Callback,\n    validateName: (name: string) => boolean\n  ): void {\n    const storages = this._getCustomPackageLocalStorages();\n    debug(`search custom local packages: %o`, JSON.stringify(storages));\n    const base = Path.dirname(this.config.self_path);\n    const self = this;\n    const storageKeys = Object.keys(storages);\n    debug(`search base: %o keys: %o`, base, storageKeys);\n\n    async.eachSeries(\n      storageKeys,\n      function (storage, cb) {\n        const position = storageKeys.indexOf(storage);\n        const base2 = Path.join(position !== 0 ? storageKeys[0] : '');\n        const storagePath: string = Path.resolve(base, base2, storage);\n        debug('search path: %o : %o', storagePath, storage);\n        fs.readdir(storagePath, (err, files) => {\n          if (err) {\n            return cb(err);\n          }\n\n          async.eachSeries(\n            files,\n            function (file, cb) {\n              debug('local-storage: [search] search file path: %o', file);\n              if (storageKeys.includes(file)) {\n                return cb();\n              }\n\n              if (file.match(/^@/)) {\n                // scoped\n                const fileLocation = Path.resolve(base, storage, file);\n                debug('search scoped file location: %o', fileLocation);\n                fs.readdir(fileLocation, function (err, files) {\n                  if (err) {\n                    return cb(err);\n                  }\n\n                  async.eachSeries(\n                    files,\n                    (file2, cb) => {\n                      if (validateName(file2)) {\n                        const packagePath = Path.resolve(base, storage, file, file2);\n\n                        fs.stat(packagePath, (err, stats) => {\n                          if (_.isNil(err) === false) {\n                            return cb(err);\n                          }\n                          const item = {\n                            name: `${file}/${file2}`,\n                            path: packagePath,\n                            time: stats.mtime.getTime(),\n                          };\n                          onPackage(item, cb);\n                        });\n                      } else {\n                        cb();\n                      }\n                    },\n                    cb\n                  );\n                });\n              } else if (validateName(file)) {\n                const base2 = Path.join(position !== 0 ? storageKeys[0] : '');\n                const packagePath = Path.resolve(base, base2, storage, file);\n                debug('search file location: %o', packagePath);\n                fs.stat(packagePath, (err, stats) => {\n                  if (_.isNil(err) === false) {\n                    return cb(err);\n                  }\n                  onPackage(\n                    {\n                      name: file,\n                      path: packagePath,\n                      time: self.getTime(stats.mtime.getTime(), stats.mtime),\n                    },\n                    cb\n                  );\n                });\n              } else {\n                cb();\n              }\n            },\n            cb\n          );\n        });\n      },\n      // @ts-ignore\n      onEnd\n    );\n  }\n\n  public remove(name: string, cb: Callback): void {\n    this.get((err, data) => {\n      if (err) {\n        cb(getInternalError('error remove private package'));\n        this.logger.error(\n          { err },\n          '[local-storage/remove]: remove the private package has failed @{err}'\n        );\n        debug('error on remove package %o', name);\n      }\n\n      const pkgName = data.indexOf(name);\n      if (pkgName !== -1) {\n        this.data.list.splice(pkgName, 1);\n\n        debug('remove package %o has been removed', name);\n      }\n\n      cb(this._sync());\n    });\n  }\n\n  /**\n   * Return all database elements.\n   * @return {Array}\n   */\n  public get(cb: Callback): void {\n    const list = this.data.list;\n    const totalItems = this.data.list.length;\n\n    cb(null, list);\n\n    debug('get full list of packages (%o) has been fetched', totalItems);\n  }\n\n  public getPackageStorage(packageName: string): IPackageStorage {\n    const packageAccess = this.config.getMatchedPackagesSpec(packageName);\n\n    const packagePath: string = this._getLocalStoragePath(\n      packageAccess ? packageAccess.storage : undefined\n    );\n    debug('storage path selected: ', packagePath);\n\n    if (_.isString(packagePath) === false) {\n      debug('the package %o has no storage defined ', packageName);\n      return;\n    }\n\n    const packageStoragePath: string = Path.join(\n      Path.resolve(Path.dirname(this.config.self_path || ''), packagePath),\n      packageName\n    );\n\n    debug('storage absolute path: ', packageStoragePath);\n\n    return new LocalDriver(packageStoragePath, this.logger);\n  }\n\n  public clean(): void {\n    this._sync();\n  }\n\n  private getTime(time: number, mtime: Date): number | Date {\n    return time ? time : mtime;\n  }\n\n  private _getCustomPackageLocalStorages(): object {\n    const storages = {};\n\n    // add custom storage if exist\n    if (this.config.storage) {\n      storages[this.config.storage] = true;\n    }\n\n    const { packages } = this.config;\n\n    if (packages) {\n      const listPackagesConf = Object.keys(packages || {});\n\n      listPackagesConf.map((pkg) => {\n        const storage = packages[pkg].storage;\n        if (storage) {\n          storages[storage] = false;\n        }\n      });\n    }\n\n    return storages;\n  }\n\n  /**\n   * Syncronize {create} database whether does not exist.\n   * @return {Error|*}\n   */\n  private _sync(): Error | null {\n    debug('sync database started');\n\n    if (this.locked) {\n      this.logger.error(\n        'Database is locked, please check error message printed during startup to ' +\n          'prevent data loss.'\n      );\n      return new Error(\n        'Verdaccio database is locked, please contact your administrator to checkout ' +\n          'logs during verdaccio startup.'\n      );\n    }\n    // Uses sync to prevent ugly race condition\n    try {\n      // https://www.npmjs.com/package/mkdirp#mkdirpsyncdir-opts\n      const folderName = Path.dirname(this.path);\n      mkdirp.sync(folderName);\n      debug('sync folder %o created succeed', folderName);\n    } catch (err) {\n      debug('sync create folder has failed with error: %o', err);\n      return null;\n    }\n\n    try {\n      fs.writeFileSync(this.path, JSON.stringify(this.data));\n      debug('sync write succeed');\n\n      return null;\n    } catch (err: any) {\n      debug('sync failed %o', err);\n\n      return err;\n    }\n  }\n\n  /**\n   * Verify the right local storage location.\n   * @param {String} path\n   * @return {String}\n   * @private\n   */\n  private _getLocalStoragePath(storage: string | void): string {\n    const globalConfigStorage = this.config ? this.config.storage : undefined;\n    if (_.isNil(globalConfigStorage)) {\n      throw new Error('global storage is required for this plugin');\n    } else {\n      if (_.isNil(storage) === false && _.isString(storage)) {\n        return Path.join(globalConfigStorage as string, storage as string);\n      }\n\n      return globalConfigStorage as string;\n    }\n  }\n\n  /**\n   * Build the local database path.\n   * @param {Object} config\n   * @return {string|String|*}\n   * @private\n   */\n  private _buildStoragePath(config: Config): string {\n    const sinopiadbPath: string = this._dbGenPath(DEPRECATED_DB_NAME, config);\n    try {\n      fs.accessSync(sinopiadbPath, fs.constants.F_OK);\n      // @ts-ignore\n      process.emitWarning('Database name deprecated!', {\n        code: 'VERCODE01',\n        detail: `Please rename database name from ${DEPRECATED_DB_NAME} to ${DB_NAME}`,\n      });\n      return sinopiadbPath;\n    } catch (err: any) {\n      if (err.code === noSuchFile) {\n        return this._dbGenPath(DB_NAME, config);\n      }\n\n      throw err;\n    }\n  }\n\n  /**\n   * Fetch local packages.\n   * @private\n   * @return {Object}\n   */\n  private _fetchLocalPackages(): LocalStorage {\n    const list: StorageList = [];\n    const emptyDatabase = { list, secret: '' };\n\n    try {\n      return loadPrivatePackages(this.path, this.logger);\n    } catch (err: any) {\n      // readFileSync is platform specific, macOS, Linux and Windows thrown an error\n      // Only recreate if file not found to prevent data loss\n      if (err.code !== noSuchFile) {\n        this.locked = true;\n        this.logger.error(\n          'Failed to read package database file, please check the error printed below:\\n',\n          `File Path: ${this.path}\\n\\n ${err.message}`\n        );\n      }\n\n      return emptyDatabase;\n    }\n  }\n}\n\nexport default LocalDatabase;\n"],"mappings":"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"}