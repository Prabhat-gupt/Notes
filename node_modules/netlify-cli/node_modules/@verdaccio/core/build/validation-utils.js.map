{"version":3,"file":"validation-utils.js","names":["isPackageNameScoped","name","startsWith","validateName","normalizedName","toLowerCase","isScoped","scopedName","split","match","includes","validatePackage","nameList","length","slice","normalizeMetadata","manifest","assert","strictEqual","_manifest","isObject","DIST_TAGS","obj","prototype","Array","isArray","validatePassword","password","validation","DEFAULT_PASSWORD_VALIDATION","RegExp"],"sources":["../src/validation-utils.ts"],"sourcesContent":["import assert from 'assert';\n\nimport { Manifest } from '@verdaccio/types';\n\nimport { DEFAULT_PASSWORD_VALIDATION, DIST_TAGS } from './constants';\n\nexport { validatePublishSingleVersion } from './schemes/publish-manifest';\n\nexport function isPackageNameScoped(name: string): boolean {\n  return name.startsWith('@');\n}\n\n/**\n * From normalize-package-data/lib/fixer.js\n * @param {*} name  the package name\n * @return {Boolean} whether is valid or not\n */\nexport function validateName(name: string): boolean {\n  if (typeof name !== 'string') {\n    return false;\n  }\n\n  let normalizedName: string = name.toLowerCase();\n\n  const isScoped: boolean = isPackageNameScoped(name);\n  const scopedName = name.split('/', 2)[1];\n\n  if (isScoped && typeof scopedName !== 'undefined') {\n    normalizedName = scopedName.toLowerCase();\n  }\n\n  /**\n   * Some context about the first regex\n   * - npm used to have a different tarball naming system.\n   * eg: http://registry.npmjs.com/thirty-two\n   * https://registry.npmjs.org/thirty-two/-/thirty-two@0.0.1.tgz\n   * The file name thirty-two@0.0.1.tgz, the version and the pkg name was separated by an at (@)\n   * while nowadays the naming system is based in dashes\n   * https://registry.npmjs.org/verdaccio/-/verdaccio-1.4.0.tgz\n   *\n   * more info here: https://github.com/rlidwka/sinopia/issues/75\n   */\n  return !(\n    !normalizedName.match(/^[-a-zA-Z0-9_.!~*'()@]+$/) ||\n    normalizedName.startsWith('.') || // \".bin\", etc.\n    ['node_modules', '__proto__', 'favicon.ico'].includes(normalizedName)\n  );\n}\n\n/**\n * Validate a package.\n * @return {Boolean} whether the package is valid or not\n */\nexport function validatePackage(name: string): boolean {\n  const nameList = name.split('/', 2);\n  if (nameList.length === 1) {\n    // normal package\n    return validateName(nameList[0]);\n  }\n  // scoped package\n  return nameList[0][0] === '@' && validateName(nameList[0].slice(1)) && validateName(nameList[1]);\n}\n\n/**\n * Validate the package metadata, add additional properties whether are missing within\n * the metadata properties.\n * @param {*} manifest\n * @param {*} name\n * @return {Object} the object with additional properties as dist-tags ad versions\n * FUTURE: rename to normalizeMetadata\n */\nexport function normalizeMetadata(manifest: Manifest, name: string): Manifest {\n  assert.strictEqual(manifest.name, name);\n  const _manifest = { ...manifest };\n\n  if (!isObject(manifest[DIST_TAGS])) {\n    _manifest[DIST_TAGS] = {};\n  }\n\n  // This may not be nee dit\n  if (!isObject(manifest['versions'])) {\n    _manifest['versions'] = {};\n  }\n\n  if (!isObject(manifest['time'])) {\n    _manifest['time'] = {};\n  }\n\n  return _manifest;\n}\n\n/**\n * Check whether an element is an Object\n * @param {*} obj the element\n * @return {Boolean}\n */\nexport function isObject(obj: any): boolean {\n  if (obj === null || typeof obj === 'undefined' || typeof obj === 'string') {\n    return false;\n  }\n\n  return (\n    (typeof obj === 'object' || typeof obj.prototype === 'undefined') &&\n    Array.isArray(obj) === false\n  );\n}\n\nexport function validatePassword(\n  password: string,\n  validation: RegExp = DEFAULT_PASSWORD_VALIDATION\n): boolean {\n  return typeof password === 'string' && validation instanceof RegExp\n    ? password.match(validation) !== null\n    : false;\n}\n"],"mappings":"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"}