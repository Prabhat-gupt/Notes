{"version":3,"file":"utils.js","names":["validateName","name","_","isString","normalizedName","toLowerCase","isScoped","startsWith","includes","scopedName","split","isUndefined","match","validatePackage","nameList","length","slice","isObject","obj","isNull","isArray","getLatestVersion","pkgInfo","DIST_TAGS","latest","buildToken","type","token","capitalize","formatAuthor","author","authorDetails","DEFAULT_USER","email","url","isNil","pad","str","max","repeat","mask","charNum","hasDiffOneKey","versions","Object","keys","isVersionValid","packageMeta","packageVersion","hasVersion","hasMatchVersion","addGravatarSupport","online","pkgInfoCopy","get","contributors","normalizeContributors","maintainers","avatar","generateGravatarUrl","GENERIC_AVATAR","isEmpty","map","contributor","maintainer","AVATAR_PROVIDER","encodeURIComponent","size","trim","toLocaleLowerCase","emailMD5","stringToMD5","deleteProperties","propertiesToDelete","objectItem","forEach","property"],"sources":["../src/utils.ts"],"sourcesContent":["import _ from 'lodash';\n\nimport { DEFAULT_USER, DIST_TAGS } from '@verdaccio/core';\nimport { Author, Manifest, Package } from '@verdaccio/types';\n\nimport { stringToMD5 } from './crypto-utils';\n\nexport type AuthorAvatar = Author & { avatar?: string };\n/**\n * From normalize-package-data/lib/fixer.js\n * @param {*} name  the package name\n * @return {Boolean} whether is valid or not\n * @deprecated\n */\nexport function validateName(name: string): boolean {\n  if (_.isString(name) === false) {\n    return false;\n  }\n  let normalizedName: string = name.toLowerCase();\n\n  const isScoped: boolean = name.startsWith('@') && name.includes('/');\n  const scopedName = name.split('/', 2)[1];\n\n  if (isScoped && !_.isUndefined(scopedName)) {\n    normalizedName = scopedName.toLowerCase();\n  }\n\n  /**\n   * Some context about the first regex\n   * - npm used to have a different tarball naming system.\n   * eg: http://registry.npmjs.com/thirty-two\n   * https://registry.npmjs.org/thirty-two/-/thirty-two@0.0.1.tgz\n   * The file name thirty-two@0.0.1.tgz, the version and the pkg name was separated by an at (@)\n   * while nowadays the naming system is based in dashes\n   * https://registry.npmjs.org/verdaccio/-/verdaccio-1.4.0.tgz\n   *\n   * more info here: https://github.com/rlidwka/sinopia/issues/75\n   */\n  return !(\n    !normalizedName.match(/^[-a-zA-Z0-9_.!~*'()@]+$/) ||\n    normalizedName.startsWith('.') || // \".bin\", etc.\n    ['node_modules', '__proto__', 'favicon.ico'].includes(normalizedName)\n  );\n}\n\n/**\n * Validate a package.\n * @return {Boolean} whether the package is valid or not\n * @deprecated\n */\nexport function validatePackage(name: string): boolean {\n  const nameList = name.split('/', 2);\n  if (nameList.length === 1) {\n    // normal package\n    return validateName(nameList[0]);\n  }\n  // scoped package\n  return nameList[0][0] === '@' && validateName(nameList[0].slice(1)) && validateName(nameList[1]);\n}\n\n/**\n * Check whether an element is an Object\n * @param {*} obj the element\n * @return {Boolean}\n * @deprecated\n */\nexport function isObject(obj: any): boolean {\n  return _.isObject(obj) && _.isNull(obj) === false && _.isArray(obj) === false;\n}\n\nexport function getLatestVersion(pkgInfo: Package): string {\n  return pkgInfo[DIST_TAGS].latest;\n}\n\nexport function buildToken(type: string, token: string): string {\n  return `${_.capitalize(type)} ${token}`;\n}\n\nexport type AuthorFormat = Author | string | null | void;\n\n/**\n * Formats author field for webui.\n * @see https://docs.npmjs.com/files/package.json#author\n * @param {string|object|undefined} author\n */\nexport function formatAuthor(author: AuthorFormat): any {\n  let authorDetails = {\n    name: DEFAULT_USER,\n    email: '',\n    url: '',\n  };\n\n  if (_.isNil(author)) {\n    return authorDetails;\n  }\n\n  if (_.isString(author)) {\n    authorDetails = {\n      ...authorDetails,\n      name: author as string,\n    };\n  }\n\n  if (_.isObject(author)) {\n    authorDetails = {\n      ...authorDetails,\n      ...(author as Author),\n    };\n  }\n\n  return authorDetails;\n}\n\n/**\n * Apply whitespaces based on the length\n * @param {*} str the log message\n * @return {String}\n */\nexport function pad(str, max): string {\n  if (str.length < max) {\n    return str + ' '.repeat(max - str.length);\n  }\n  return str;\n}\n\n/**\n * return a masquerade string with its first and last {charNum} and three dots in between.\n * @param {String} str\n * @param {Number} charNum\n * @returns {String}\n */\nexport function mask(str: string, charNum = 3): string {\n  return `${str.slice(0, charNum)}...${str.slice(-charNum)}`;\n}\n\n// @deprecated\nexport function hasDiffOneKey(versions): boolean {\n  return Object.keys(versions).length !== 1;\n}\n\nexport function isVersionValid(packageMeta, packageVersion): boolean {\n  const hasVersion = typeof packageVersion !== 'undefined';\n  if (!hasVersion) {\n    return false;\n  }\n\n  const hasMatchVersion = Object.keys(packageMeta.versions).includes(packageVersion);\n  return hasMatchVersion;\n}\n\nexport function addGravatarSupport(pkgInfo: Manifest, online = true): AuthorAvatar {\n  const pkgInfoCopy = { ...pkgInfo } as any;\n  const author: any = _.get(pkgInfo, 'latest.author', null) as any;\n  const contributors: AuthorAvatar[] = normalizeContributors(\n    _.get(pkgInfo, 'latest.contributors', [])\n  );\n  const maintainers = _.get(pkgInfo, 'latest.maintainers', []);\n\n  // for author.\n  if (author && _.isObject(author)) {\n    const { email } = author as Author;\n    pkgInfoCopy.latest.author.avatar = generateGravatarUrl(email, online);\n  }\n\n  if (author && _.isString(author)) {\n    pkgInfoCopy.latest.author = {\n      avatar: GENERIC_AVATAR,\n      email: '',\n      author,\n    };\n  }\n\n  // for contributors\n  if (_.isEmpty(contributors) === false) {\n    pkgInfoCopy.latest.contributors = contributors.map((contributor): AuthorAvatar => {\n      if (isObject(contributor)) {\n        contributor.avatar = generateGravatarUrl(contributor.email, online);\n      } else if (_.isString(contributor)) {\n        contributor = {\n          avatar: GENERIC_AVATAR,\n          email: contributor,\n          name: contributor,\n        };\n      }\n\n      return contributor;\n    });\n  }\n\n  // for maintainers\n  if (_.isEmpty(maintainers) === false) {\n    pkgInfoCopy.latest.maintainers = maintainers.map((maintainer): void => {\n      // @ts-ignore\n      maintainer.avatar = generateGravatarUrl(maintainer.email, online);\n      return maintainer;\n    });\n  }\n\n  return pkgInfoCopy;\n}\n\nconst AVATAR_PROVIDER = 'https://www.gravatar.com/avatar/';\nexport const GENERIC_AVATAR =\n  'data:image/svg+xml;utf8,' +\n  encodeURIComponent(\n    '<svg height=\"100\" viewBox=\"-27 24 100 100\" width=\"100\" xmlns=\"http://www.w3.org/' +\n      '2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"><defs><circle cx=\"23\" cy=\"7' +\n      '4\" id=\"a\" r=\"50\"/></defs><use fill=\"#F5EEE5\" overflow=\"visible\" xlink:href=\"#a\"/' +\n      '><clipPath id=\"b\"><use overflow=\"visible\" xlink:href=\"#a\"/></clipPath><g clip-pa' +\n      'th=\"url(#b)\"><defs><path d=\"M36 95.9c0 4 4.7 5.2 7.1 5.8 7.6 2 22.8 5.9 22.8 5.9' +\n      ' 3.2 1.1 5.7 3.5 7.1 6.6v9.8H-27v-9.8c1.3-3.1 3.9-5.5 7.1-6.6 0 0 15.2-3.9 22.8-' +\n      '5.9 2.4-.6 7.1-1.8 7.1-5.8V85h26v10.9z\" id=\"c\"/></defs><use fill=\"#E6C19C\" overf' +\n      'low=\"visible\" xlink:href=\"#c\"/><clipPath id=\"d\"><use overflow=\"visible\" xlink:hr' +\n      'ef=\"#c\"/></clipPath><path clip-path=\"url(#d)\" d=\"M23.2 35h.2c3.3 0 8.2.2 11.4 2 ' +\n      '3.3 1.9 7.3 5.6 8.5 12.1 2.4 13.7-2.1 35.4-6.3 42.4-4 6.7-9.8 9.2-13.5 9.4H23h-.' +\n      '1c-3.7-.2-9.5-2.7-13.5-9.4-4.2-7-8.7-28.7-6.3-42.4 1.2-6.5 5.2-10.2 8.5-12.1 3.2' +\n      '-1.8 8.1-2 11.4-2h.2z\" fill=\"#D4B08C\"/></g><path d=\"M22.6 40c19.1 0 20.7 13.8 20' +\n      '.8 15.1 1.1 11.9-3 28.1-6.8 33.7-4 5.9-9.8 8.1-13.5 8.3h-.5c-3.8-.3-9.6-2.5-13.6' +\n      '-8.4-3.8-5.6-7.9-21.8-6.8-33.8C2.3 53.7 3.5 40 22.6 40z\" fill=\"#F2CEA5\"/></svg>'\n  );\n\n/**\n * Generate gravatar url from email address\n */\nexport function generateGravatarUrl(email: string | void = '', online: boolean = true): string {\n  if (online && _.isString(email) && _.size(email) > 0) {\n    email = email.trim().toLocaleLowerCase();\n    const emailMD5 = stringToMD5(email);\n    return `${AVATAR_PROVIDER}${emailMD5}`;\n  }\n  return GENERIC_AVATAR;\n}\n\nexport function normalizeContributors(contributors: Author[]): Author[] {\n  if (_.isNil(contributors)) {\n    return [];\n  } else if (contributors && _.isArray(contributors) === false) {\n    // FIXME: this branch is clearly no an array, still tsc complains\n    // @ts-ignore\n    return [contributors];\n  } else if (_.isString(contributors)) {\n    return [\n      {\n        name: contributors,\n      },\n    ];\n  }\n\n  return contributors;\n}\n\nexport function deleteProperties(propertiesToDelete: string[], objectItem: any): any {\n  _.forEach(propertiesToDelete, (property): any => {\n    delete objectItem[property];\n  });\n\n  return objectItem;\n}\n"],"mappings":"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"}