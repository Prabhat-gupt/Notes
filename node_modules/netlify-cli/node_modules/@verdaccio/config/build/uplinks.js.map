{"version":3,"file":"uplinks.js","names":["DEFAULT_REGISTRY","DEFAULT_UPLINK","BLACKLIST","all","anonymous","undefined","owner","none","uplinkSanityCheck","uplinks","users","newUplinks","_","clone","newUsers","uplink","Object","prototype","hasOwnProperty","call","cache","sanityCheckNames","sanityCheckUplinksProps","configUpLinks","assert","url","isString","replace","hasProxyTo","pkg","upLink","packages","matchedPkg","getMatchedPackagesSpec","proxyList","proxy","some","curr","item","match","isNil"],"sources":["../src/uplinks.ts"],"sourcesContent":["import assert from 'assert';\nimport _ from 'lodash';\n\nimport { PackageList, UpLinksConfList } from '@verdaccio/types';\nimport { getMatchedPackagesSpec } from '@verdaccio/utils';\n\nexport const DEFAULT_REGISTRY = 'https://registry.npmjs.org';\nexport const DEFAULT_UPLINK = 'npmjs';\n\nconst BLACKLIST = {\n  all: true,\n  anonymous: true,\n  undefined: true,\n  owner: true,\n  none: true,\n};\n\nexport function uplinkSanityCheck(\n  uplinks: UpLinksConfList,\n  users: any = BLACKLIST\n): UpLinksConfList {\n  const newUplinks = _.clone(uplinks);\n  let newUsers = _.clone(users);\n\n  for (const uplink in newUplinks) {\n    if (Object.prototype.hasOwnProperty.call(newUplinks, uplink)) {\n      if (typeof newUplinks[uplink].cache === 'undefined') {\n        newUplinks[uplink].cache = true;\n      }\n      newUsers = sanityCheckNames(uplink, newUsers);\n    }\n  }\n\n  return newUplinks;\n}\n\nexport function sanityCheckUplinksProps(configUpLinks: UpLinksConfList): UpLinksConfList {\n  const uplinks = _.clone(configUpLinks);\n\n  for (const uplink in uplinks) {\n    if (Object.prototype.hasOwnProperty.call(uplinks, uplink)) {\n      assert(uplinks[uplink].url, 'CONFIG: no url for uplink: ' + uplink);\n      assert(_.isString(uplinks[uplink].url), 'CONFIG: wrong url format for uplink: ' + uplink);\n      uplinks[uplink].url = uplinks[uplink].url.replace(/\\/$/, '');\n    }\n  }\n\n  return uplinks;\n}\n\nexport function hasProxyTo(pkg: string, upLink: string, packages: PackageList): boolean {\n  const matchedPkg = getMatchedPackagesSpec(pkg, packages);\n  const proxyList = typeof matchedPkg !== 'undefined' ? matchedPkg.proxy : [];\n  if (proxyList) {\n    return proxyList.some((curr) => upLink === curr);\n  }\n\n  return false;\n}\n\nexport function sanityCheckNames(item: string, users: any): any {\n  assert(\n    item !== 'all' &&\n      item !== 'owner' &&\n      item !== 'anonymous' &&\n      item !== 'undefined' &&\n      item !== 'none',\n    'CONFIG: reserved uplink name: ' + item\n  );\n  assert(!item.match(/\\s/), 'CONFIG: invalid uplink name: ' + item);\n  assert(_.isNil(users[item]), 'CONFIG: duplicate uplink name: ' + item);\n  users[item] = true;\n\n  return users;\n}\n"],"mappings":"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"}