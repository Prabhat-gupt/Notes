{"version":3,"file":"parse.js","names":["debug","buildDebug","parseConfigFile","configPath","fileExists","Error","test","yamlConfig","YAML","parse","fs","readFileSync","strict","Object","assign","config_path","jsonConfig","require","e","code","message","APP_ERROR","CONFIG_NOT_VALID","fromJStoYAML","config","isObject","stringify"],"sources":["../src/parse.ts"],"sourcesContent":["import buildDebug from 'debug';\nimport fs from 'fs';\nimport { isObject } from 'lodash';\nimport YAML from 'yaml';\n\nimport { APP_ERROR } from '@verdaccio/core';\nimport { ConfigYaml } from '@verdaccio/types';\n\nimport { fileExists } from './config-utils';\n\nconst debug = buildDebug('verdaccio:config:parse');\n\n/**\n * Parse a config file from yaml to JSON.\n * @param configPath the absolute path of the configuration file\n */\nexport function parseConfigFile(configPath: string): ConfigYaml & {\n  // @deprecated use configPath instead\n  config_path: string;\n  configPath: string;\n} {\n  debug('parse config file %s', configPath);\n  if (!fileExists(configPath)) {\n    throw new Error(`config file does not exist or not reachable`);\n  }\n  debug('parsing config file: %o', configPath);\n  try {\n    if (/\\.ya?ml$/i.test(configPath)) {\n      const yamlConfig = YAML.parse(fs.readFileSync(configPath, 'utf8'), {\n        strict: false,\n      }) as ConfigYaml;\n\n      return Object.assign({}, yamlConfig, {\n        configPath,\n        // @deprecated use configPath instead\n        config_path: configPath,\n      });\n    }\n\n    const jsonConfig = require(configPath) as ConfigYaml;\n    return Object.assign({}, jsonConfig, {\n      configPath,\n      // @deprecated use configPath instead\n      config_path: configPath,\n    });\n  } catch (e: any) {\n    if (e.code !== 'MODULE_NOT_FOUND') {\n      debug('config module not found %o error: %o', configPath, e.message);\n      throw Error(APP_ERROR.CONFIG_NOT_VALID);\n    }\n\n    throw e;\n  }\n}\n\nexport function fromJStoYAML(config: Partial<ConfigYaml>): string | null {\n  debug('convert config from JSON to YAML');\n  if (isObject(config)) {\n    return YAML.stringify(config);\n  } else {\n    throw new Error(`config is not a valid object`);\n  }\n}\n"],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AAEA;AAGA;AAA4C;AAE5C,MAAMA,KAAK,GAAG,IAAAC,cAAU,EAAC,wBAAwB,CAAC;;AAElD;AACA;AACA;AACA;AACO,SAASC,eAAe,CAACC,UAAkB,EAIhD;EACAH,KAAK,CAAC,sBAAsB,EAAEG,UAAU,CAAC;EACzC,IAAI,CAAC,IAAAC,uBAAU,EAACD,UAAU,CAAC,EAAE;IAC3B,MAAM,IAAIE,KAAK,CAAE,6CAA4C,CAAC;EAChE;EACAL,KAAK,CAAC,yBAAyB,EAAEG,UAAU,CAAC;EAC5C,IAAI;IACF,IAAI,WAAW,CAACG,IAAI,CAACH,UAAU,CAAC,EAAE;MAChC,MAAMI,UAAU,GAAGC,aAAI,CAACC,KAAK,CAACC,WAAE,CAACC,YAAY,CAACR,UAAU,EAAE,MAAM,CAAC,EAAE;QACjES,MAAM,EAAE;MACV,CAAC,CAAe;MAEhB,OAAOC,MAAM,CAACC,MAAM,CAAC,CAAC,CAAC,EAAEP,UAAU,EAAE;QACnCJ,UAAU;QACV;QACAY,WAAW,EAAEZ;MACf,CAAC,CAAC;IACJ;IAEA,MAAMa,UAAU,GAAGC,OAAO,CAACd,UAAU,CAAe;IACpD,OAAOU,MAAM,CAACC,MAAM,CAAC,CAAC,CAAC,EAAEE,UAAU,EAAE;MACnCb,UAAU;MACV;MACAY,WAAW,EAAEZ;IACf,CAAC,CAAC;EACJ,CAAC,CAAC,OAAOe,CAAM,EAAE;IACf,IAAIA,CAAC,CAACC,IAAI,KAAK,kBAAkB,EAAE;MACjCnB,KAAK,CAAC,sCAAsC,EAAEG,UAAU,EAAEe,CAAC,CAACE,OAAO,CAAC;MACpE,MAAMf,KAAK,CAACgB,eAAS,CAACC,gBAAgB,CAAC;IACzC;IAEA,MAAMJ,CAAC;EACT;AACF;AAEO,SAASK,YAAY,CAACC,MAA2B,EAAiB;EACvExB,KAAK,CAAC,kCAAkC,CAAC;EACzC,IAAI,IAAAyB,gBAAQ,EAACD,MAAM,CAAC,EAAE;IACpB,OAAOhB,aAAI,CAACkB,SAAS,CAACF,MAAM,CAAC;EAC/B,CAAC,MAAM;IACL,MAAM,IAAInB,KAAK,CAAE,8BAA6B,CAAC;EACjD;AACF"}